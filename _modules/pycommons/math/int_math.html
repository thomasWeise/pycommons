<!doctype html><html data-content_root=../../../ lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0"name=viewport><title>pycommons.math.int_math — pycommons 0.8.70 documentation</title><link href="../../../_static/pygments.css?v=b86133f3"rel=stylesheet><link href="../../../_static/bizstyle.css?v=5283bb3d"rel=stylesheet><script src="../../../_static/documentation_options.js?v=bfdce523"></script><script src="../../../_static/doctools.js?v=9bcbadda"></script><script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script><script src=../../../_static/bizstyle.js></script><link href=https://thomasweise.github.io/pycommons/_modules/pycommons/math/int_math.html rel=canonical><link href=../../../genindex.html rel=index title=Index><link href=../../../search.html rel=search title=Search><meta content="width=device-width,initial-scale=1.0"name=viewport><body><div aria-label=Related class=related role=navigation><h3>Navigation</h3><ul><li class=right style=margin-right:10px><a title="General Index"accesskey=I href=../../../genindex.html>index</a><li class=right><a title="Python Module Index"href=../../../py-modindex.html>modules</a> |<li class="nav-item nav-item-0"><a href=../../../index.html>pycommons 0.8.70 documentation</a> »<li class="nav-item nav-item-1"><a accesskey=U href=../../index.html>Module code</a> »<li class="nav-item nav-item-this"><a href>pycommons.math.int_math</a></ul></div><div class=document><div class=documentwrapper><div class=bodywrapper><div class=body role=main><h1>Source code for pycommons.math.int_math</h1><div class=highlight><pre>
<span></span><span class=sd>"""</span>
<span class=sd>Mathematics routines combining integers and floats.</span>

<span class=sd>These routines try to return results with the highest possible precision,</span>
<span class=sd>ideally as integers.</span>
<span class=sd>If floating point values need to be converted to integers, then we round</span>
<span class=sd>towards the nearest integer numbers, whereas `0.5` is always rounded up and</span>
<span class=sd>`-0.5` is always rounded down.</span>
<span class=sd>Thus, `1.5` becomes `2` and `-1.5` becomes `-2`.</span>
<span class=sd>"""</span>

<span class=kn>from</span><span class=w> </span><span class=nn>contextlib</span><span class=w> </span><span class=kn>import</span> <span class=n>suppress</span>
<span class=kn>from</span><span class=w> </span><span class=nn>math</span><span class=w> </span><span class=kn>import</span> <span class=n>gcd</span><span class=p>,</span> <span class=n>isfinite</span><span class=p>,</span> <span class=n>isqrt</span><span class=p>,</span> <span class=n>sqrt</span>
<span class=kn>from</span><span class=w> </span><span class=nn>sys</span><span class=w> </span><span class=kn>import</span> <span class=n>float_info</span>
<span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Final</span>

<span class=kn>from</span><span class=w> </span><span class=nn>pycommons.types</span><span class=w> </span><span class=kn>import</span> <span class=n>type_error</span>

<span class=c1>#: The positive limit for doubles that can be represented exactly as ints.</span>
<span class=c1>#: We cannot represent any number `z` with `|z| >= 2 ** 53` as float without</span>
<span class=c1>#: losing some digits, because floats have only 52 bits.</span>
<span class=c1>#: `float(9007199254740992) == 9007199254740992.0`</span>
<span class=c1>#: `float(9007199254740991) == 9007199254740991.0`</span>
<span class=c1>#: But:</span>
<span class=c1>#: #: `float(9007199254740993) == 9007199254740992.0`.</span>
<span class=n>__DBL_INT_LIMIT_P_I</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>**</span> <span class=n>float_info</span><span class=o>.</span><span class=n>mant_dig</span>
<span class=c1>#: The positive limit for doubles that can be represented exactly as ints.</span>
<span class=n>__DBL_INT_LIMIT_P_F</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>float</span><span class=p>]</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>__DBL_INT_LIMIT_P_I</span><span class=p>)</span>  <span class=c1># = 1 << 53</span>
<span class=c1>#: The negative limit for doubles that can be represented exactly as ints.</span>
<span class=n>__DBL_INT_LIMIT_N_I</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=n>__DBL_INT_LIMIT_P_I</span>
<span class=c1>#: The negative limit for doubles that can be represented exactly as ints.</span>
<span class=n>__DBL_INT_LIMIT_N_F</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>float</span><span class=p>]</span> <span class=o>=</span> <span class=n>__DBL_INT_LIMIT_N_I</span>


<span class=k>def</span><span class=w> </span><span class=nf>__try_int</span><span class=p>(</span><span class=n>val</span><span class=p>:</span> <span class=nb>float</span><span class=p>)</span> <span class=o>-></span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Convert a float to an int without any fancy checks.</span>

<span class=sd>    :param val: the flot</span>
<span class=sd>    :returns: the float or int</span>

<span class=sd>    >>> from math import inf, nan, nextafter</span>
<span class=sd>    >>> type(__try_int(0.0))</span>
<span class=sd>    &LTclass 'int'></span>
<span class=sd>    >>> type(__try_int(0.5))</span>
<span class=sd>    &LTclass 'float'></span>
<span class=sd>    >>> type(__try_int(inf))</span>
<span class=sd>    &LTclass 'float'></span>
<span class=sd>    >>> type(__try_int(-inf))</span>
<span class=sd>    &LTclass 'float'></span>
<span class=sd>    >>> type(__try_int(nan))</span>
<span class=sd>    &LTclass 'float'></span>
<span class=sd>    >>> 1 << 53</span>
<span class=sd>    9007199254740992</span>
<span class=sd>    >>> type(__try_int(9007199254740992.0))</span>
<span class=sd>    &LTclass 'int'></span>
<span class=sd>    >>> __try_int(9007199254740992.0)</span>
<span class=sd>    9007199254740992</span>
<span class=sd>    >>> too_big = nextafter(9007199254740992.0, inf)</span>
<span class=sd>    >>> print(too_big)</span>
<span class=sd>    9007199254740994.0</span>
<span class=sd>    >>> type(__try_int(too_big))</span>
<span class=sd>    &LTclass 'float'></span>
<span class=sd>    >>> type(__try_int(-9007199254740992.0))</span>
<span class=sd>    &LTclass 'int'></span>
<span class=sd>    >>> __try_int(-9007199254740992.0)</span>
<span class=sd>    -9007199254740992</span>
<span class=sd>    >>> type(__try_int(-too_big))</span>
<span class=sd>    &LTclass 'float'></span>
<span class=sd>    """</span>
    <span class=k>if</span> <span class=n>__DBL_INT_LIMIT_N_F</span> <span class=o><=</span> <span class=n>val</span> <span class=o><=</span> <span class=n>__DBL_INT_LIMIT_P_F</span><span class=p>:</span>
        <span class=n>a</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>val</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>a</span> <span class=o>==</span> <span class=n>val</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>a</span>
    <span class=k>return</span> <span class=n>val</span>


<div class=viewcode-block id=try_int>
<a class=viewcode-back href=../../../pycommons.math.html#pycommons.math.int_math.try_int>[docs]</a>
<span class=k>def</span><span class=w> </span><span class=nf>try_int</span><span class=p>(</span><span class=n>value</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>)</span> <span class=o>-></span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Attempt to convert a float to an integer.</span>

<span class=sd>    This method will convert a floating point number to an integer if the</span>
<span class=sd>    floating point number was representing an exact integer. This is the</span>
<span class=sd>    case if it has a) no fractional part and b) is in the range</span>
<span class=sd>    `-9007199254740992...9007199254740992`, i.e., the range where `+1` and</span>
<span class=sd>    `-1` work without loss of precision.</span>

<span class=sd>    :param value: the input value, which must either be `int` or `float`</span>
<span class=sd>    :returns: an `int` if `value` can be represented as `int` without loss of</span>
<span class=sd>        precision, `val` otherwise</span>
<span class=sd>    :raises TypeError: if `value` is neither an instance of `int` nor of</span>
<span class=sd>        `float`</span>
<span class=sd>    :raises ValueError: if `value` is a `float`, but not finite</span>

<span class=sd>    >>> print(type(try_int(10.5)))</span>
<span class=sd>    &LTclass 'float'></span>
<span class=sd>    >>> print(type(try_int(10)))</span>
<span class=sd>    &LTclass 'int'></span>

<span class=sd>    >>> from math import inf, nan, nextafter</span>
<span class=sd>    >>> type(try_int(0.0))</span>
<span class=sd>    &LTclass 'int'></span>
<span class=sd>    >>> type(try_int(0.5))</span>
<span class=sd>    &LTclass 'float'></span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_int(inf)</span>
<span class=sd>    ... except ValueError as ve:</span>
<span class=sd>    ...     print(ve)</span>
<span class=sd>    Value must be finite, but is inf.</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_int(-inf)</span>
<span class=sd>    ... except ValueError as ve:</span>
<span class=sd>    ...     print(ve)</span>
<span class=sd>    Value must be finite, but is -inf.</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_int(nan)</span>
<span class=sd>    ... except ValueError as ve:</span>
<span class=sd>    ...     print(ve)</span>
<span class=sd>    Value must be finite, but is nan.</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_int("blab")  # noqa  # type: off</span>
<span class=sd>    ... except TypeError as te:</span>
<span class=sd>    ...     print(te)</span>
<span class=sd>    value should be an instance of any in {float, int} but is str, namely \</span>
<span class=sd>'blab'.</span>

<span class=sd>    >>> type(try_int(9007199254740992.0))</span>
<span class=sd>    &LTclass 'int'></span>
<span class=sd>    >>> try_int(9007199254740992.0)</span>
<span class=sd>    9007199254740992</span>
<span class=sd>    >>> too_big = nextafter(9007199254740992.0, inf)</span>
<span class=sd>    >>> print(too_big)</span>
<span class=sd>    9007199254740994.0</span>
<span class=sd>    >>> type(try_int(too_big))</span>
<span class=sd>    &LTclass 'float'></span>
<span class=sd>    >>> type(try_int(-9007199254740992.0))</span>
<span class=sd>    &LTclass 'int'></span>
<span class=sd>    >>> try_int(-9007199254740992.0)</span>
<span class=sd>    -9007199254740992</span>
<span class=sd>    >>> type(try_int(-too_big))</span>
<span class=sd>    &LTclass 'float'></span>
<span class=sd>    """</span>
    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>value</span>
    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=nb>float</span><span class=p>):</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>isfinite</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Value must be finite, but is </span><span class=si>{</span><span class=n>value</span><span class=si>}</span><span class=s2>."</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>__DBL_INT_LIMIT_N_F</span> <span class=o><=</span> <span class=n>value</span> <span class=o><=</span> <span class=n>__DBL_INT_LIMIT_P_F</span><span class=p>:</span>
            <span class=n>a</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>a</span> <span class=o>==</span> <span class=n>value</span><span class=p>:</span>
                <span class=k>return</span> <span class=n>a</span>
        <span class=k>return</span> <span class=n>value</span>
    <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=s2>"value"</span><span class=p>,</span> <span class=p>(</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>))</span></div>



<div class=viewcode-block id=float_to_frac>
<a class=viewcode-back href=../../../pycommons.math.html#pycommons.math.int_math.float_to_frac>[docs]</a>
<span class=k>def</span><span class=w> </span><span class=nf>float_to_frac</span><span class=p>(</span><span class=n>value</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>)</span> <span class=o>-></span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>int</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Turn a floating point number into an integer fraction.</span>

<span class=sd>    If we want to translate a floating point number to an integer fraction,</span>
<span class=sd>    then we have several possible ways to go about this. The reason is that,</span>
<span class=sd>    due to the loss in precision when representing fractions as floating point</span>
<span class=sd>    numbers, several different integer fractions can produce the exactly same</span>
<span class=sd>    floating point number.</span>

<span class=sd>    One choice would be to use :meth:`float.as_integer_ratio`, which turns the</span>
<span class=sd>    binary representation of the floating point number to an integer fraction.</span>
<span class=sd>    This is the canonical way that, without losing any precision, will return</span>
<span class=sd>    an integer fraction that fits exactly to the floating point value.</span>

<span class=sd>    However, as said, there may be multiple such fractions. And some of them</span>
<span class=sd>    may be more "compact" than others.</span>

<span class=sd>    A second approach would be to first represent the floating point value as</span>
<span class=sd>    a string. The string that this produces also represents exactly this</span>
<span class=sd>    floating point value, obviously. Now we can translate the string to a</span>
<span class=sd>    fraction - and this can give us a different result.</span>

<span class=sd>    Which of the two is right?</span>

<span class=sd>    Both of them are. Kind of. So I'd figure we test both and stick with the</span>
<span class=sd>    :meth:`float.as_integer_ratio` default result - unless the string path</span>
<span class=sd>    provides a more compact representation. As simple yard stick, in such</span>
<span class=sd>    cases, we use the fraction with the smaller denominator. If the</span>
<span class=sd>    demoninators are the same, then we use the one with the smaller absolute</span>
<span class=sd>    numerator.</span>

<span class=sd>    :param value: the floating point value</span>
<span class=sd>    :returns: the integer fraction</span>
<span class=sd>    :raises TypeError: if value is neither an integer nor a float</span>
<span class=sd>    :raises ValueError: if value is not finite</span>

<span class=sd>    >>> float_to_frac(0.1)</span>
<span class=sd>    (1, 10)</span>

<span class=sd>    >>> float_to_frac(1e-1)</span>
<span class=sd>    (1, 10)</span>

<span class=sd>    >>> float_to_frac(1e-20)</span>
<span class=sd>    (1, 100000000000000000000)</span>

<span class=sd>    >>> 1e-20.as_integer_ratio()</span>
<span class=sd>    (6646139978924579, 664613997892457936451903530140172288)</span>

<span class=sd>    >>> float_to_frac(1e-30)</span>
<span class=sd>    (1, 1000000000000000000000000000000)</span>

<span class=sd>    >>> float_to_frac(1e30)</span>
<span class=sd>    (1000000000000000000000000000000, 1)</span>

<span class=sd>    >>> float_to_frac(1000)</span>
<span class=sd>    (1000, 1)</span>

<span class=sd>    >>> float_to_frac(1000.567)</span>
<span class=sd>    (1000567, 1000)</span>

<span class=sd>    >>> float_to_frac(1.234e-5)</span>
<span class=sd>    (617, 50000000)</span>

<span class=sd>    >>> float_to_frac(1.234e5)</span>
<span class=sd>    (123400, 1)</span>

<span class=sd>    >>> float_to_frac(0)</span>
<span class=sd>    (0, 1)</span>
<span class=sd>    >>> 0 / 1</span>
<span class=sd>    0.0</span>

<span class=sd>    >>> float_to_frac(-5376935265607590)</span>
<span class=sd>    (-5376935265607590, 1)</span>
<span class=sd>    >>> -5376935265607590 / 1</span>
<span class=sd>    -5376935265607590.0</span>

<span class=sd>    >>> float_to_frac(4)</span>
<span class=sd>    (4, 1)</span>
<span class=sd>    >>> 4 / 1</span>
<span class=sd>    4.0</span>

<span class=sd>    >>> float_to_frac(-21844.45693689149)</span>
<span class=sd>    (-2184445693689149, 100000000000)</span>
<span class=sd>    >>> -2184445693689149 / 100000000000</span>
<span class=sd>    -21844.45693689149</span>

<span class=sd>    >>> float_to_frac(-3010907.436657168)</span>
<span class=sd>    (-188181714791073, 62500000)</span>
<span class=sd>    >>> -188181714791073 / 62500000</span>
<span class=sd>    -3010907.436657168</span>

<span class=sd>    >>> float_to_frac(13660.023207762431)</span>
<span class=sd>    (1877419294078101, 137438953472)</span>
<span class=sd>    >>> 1877419294078101 / 137438953472</span>
<span class=sd>    13660.023207762431</span>

<span class=sd>    >>> float_to_frac(438027.68586526066)</span>
<span class=sd>    (58791080797933, 134217728)</span>
<span class=sd>    >>> 58791080797933 / 134217728</span>
<span class=sd>    438027.68586526066</span>

<span class=sd>    >>> float_to_frac(-8338355882.478134)</span>
<span class=sd>    (-546462491114087, 65536)</span>
<span class=sd>    >>> -546462491114087 / 65536</span>
<span class=sd>    -8338355882.478134</span>

<span class=sd>    >>> float_to_frac(-32835294.95774138)</span>
<span class=sd>    (-275442417964869, 8388608)</span>
<span class=sd>    >>> -275442417964869 / 8388608</span>
<span class=sd>    -32835294.95774138</span>

<span class=sd>    >>> float_to_frac(-0.8436071305882418)</span>
<span class=sd>    (-3799268758964299, 4503599627370496)</span>
<span class=sd>    >>> -3799268758964299 / 4503599627370496</span>
<span class=sd>    -0.8436071305882418</span>

<span class=sd>    >>> float_to_frac(-971533.786640197)</span>
<span class=sd>    (-32599264379521, 33554432)</span>
<span class=sd>    >>> -32599264379521 / 33554432</span>
<span class=sd>    -971533.786640197</span>

<span class=sd>    >>> float_to_frac(187487280836.01147)</span>
<span class=sd>    (767947902304303, 4096)</span>
<span class=sd>    >>> 767947902304303 / 4096</span>
<span class=sd>    187487280836.01147</span>

<span class=sd>    >>> float_to_frac(24214223389953.125)</span>
<span class=sd>    (193713787119625, 8)</span>
<span class=sd>    >>> 193713787119625 / 8</span>
<span class=sd>    24214223389953.125</span>

<span class=sd>    >>> float_to_frac(2645.112807929305)</span>
<span class=sd>    (363541536137187, 137438953472)</span>
<span class=sd>    >>> 363541536137187 / 137438953472</span>
<span class=sd>    2645.112807929305</span>

<span class=sd>    >>> float_to_frac(92129361.64291245)</span>
<span class=sd>    (1545674200225257, 16777216)</span>
<span class=sd>    >>> 1545674200225257 / 16777216</span>
<span class=sd>    92129361.64291245</span>

<span class=sd>    >>> float_to_frac(7218177.564653773)</span>
<span class=sd>    (1937614786056805, 268435456)</span>
<span class=sd>    >>> 1937614786056805 / 268435456</span>
<span class=sd>    7218177.564653773</span>

<span class=sd>    >>> float_to_frac(-1.4589908563595052e+16)</span>
<span class=sd>    (-14589908563595052, 1)</span>
<span class=sd>    >>> -14589908563595052 / 1</span>
<span class=sd>    -1.4589908563595052e+16</span>

<span class=sd>    >>> float_to_frac(-1.607745417434216e+16)</span>
<span class=sd>    (-16077454174342160, 1)</span>
<span class=sd>    >>> -16077454174342160 / 1</span>
<span class=sd>    -1.607745417434216e+16</span>

<span class=sd>    >>> float_to_frac(-952261813.8291152)</span>
<span class=sd>    (-595163633643197, 625000)</span>
<span class=sd>    >>> -595163633643197 / 625000</span>
<span class=sd>    -952261813.8291152</span>

<span class=sd>    >>> float_to_frac(124.69515801820336)</span>
<span class=sd>    (779344737613771, 6250000000000)</span>
<span class=sd>    >>> 779344737613771 / 6250000000000</span>
<span class=sd>    124.69515801820336</span>

<span class=sd>    >>> float_to_frac(1.041491959175676e+16)</span>
<span class=sd>    (10414919591756760, 1)</span>
<span class=sd>    >>> 10414919591756760 / 1</span>
<span class=sd>    1.041491959175676e+16</span>

<span class=sd>    >>> float_to_frac(1.4933667846659504e+16)</span>
<span class=sd>    (14933667846659504, 1)</span>
<span class=sd>    >>> 14933667846659504 / 1</span>
<span class=sd>    1.4933667846659504e+16</span>

<span class=sd>    >>> float_to_frac(-6.034817133993009e-05)</span>
<span class=sd>    (-271784001959, 4503599627370496)</span>
<span class=sd>    >>> -271784001959 / 4503599627370496</span>
<span class=sd>    -6.034817133993009e-05</span>

<span class=sd>    >>> float_to_frac(-2.682658826813622e-05)</span>
<span class=sd>    (-1887753327, 70368744177664)</span>
<span class=sd>    >>> -1887753327 / 70368744177664</span>
<span class=sd>    -2.682658826813622e-05</span>

<span class=sd>    >>> float_to_frac(6.342974725370709e-05)</span>
<span class=sd>    (17853886631, 281474976710656)</span>
<span class=sd>    >>> 17853886631 / 281474976710656</span>
<span class=sd>    6.342974725370709e-05</span>

<span class=sd>    >>> float_to_frac(8.759559844406795e-05)</span>
<span class=sd>    (3081996129, 35184372088832)</span>
<span class=sd>    >>> 3081996129 / 35184372088832</span>
<span class=sd>    8.759559844406795e-05</span>

<span class=sd>    >>> float_to_frac(-9.6e-09)</span>
<span class=sd>    (-3, 312500000)</span>
<span class=sd>    >>> -3 / 312500000</span>
<span class=sd>    -9.6e-09</span>

<span class=sd>    >>> float_to_frac(-0.4)</span>
<span class=sd>    (-2, 5)</span>
<span class=sd>    >>> -2 / 5</span>
<span class=sd>    -0.4</span>

<span class=sd>    >>> float_to_frac(2e-10)</span>
<span class=sd>    (1, 5000000000)</span>
<span class=sd>    >>> 1 / 5000000000</span>
<span class=sd>    2e-10</span>

<span class=sd>    >>> float_to_frac(0.3)</span>
<span class=sd>    (3, 10)</span>
<span class=sd>    >>> 3 / 10</span>
<span class=sd>    0.3</span>

<span class=sd>    >>> float_to_frac(-3e-09)</span>
<span class=sd>    (-3, 1000000000)</span>
<span class=sd>    >>> -3 / 1000000000</span>
<span class=sd>    -3e-09</span>

<span class=sd>    >>> float_to_frac(1e-07)</span>
<span class=sd>    (1, 10000000)</span>
<span class=sd>    >>> 1 / 10000000</span>
<span class=sd>    1e-07</span>

<span class=sd>    >>> float_to_frac(-8e-08)</span>
<span class=sd>    (-1, 12500000)</span>
<span class=sd>    >>> -1 / 12500000</span>
<span class=sd>    -8e-08</span>

<span class=sd>    >>> float_to_frac(-0.01)</span>
<span class=sd>    (-1, 100)</span>
<span class=sd>    >>> -1 / 100</span>
<span class=sd>    -0.01</span>

<span class=sd>    >>> float_to_frac(1e-08)</span>
<span class=sd>    (1, 100000000)</span>
<span class=sd>    >>> 1 / 100000000</span>
<span class=sd>    1e-08</span>

<span class=sd>    >>> float_to_frac(0.01)</span>
<span class=sd>    (1, 100)</span>
<span class=sd>    >>> 1 / 100</span>
<span class=sd>    0.01</span>

<span class=sd>    >>> float_to_frac(-2e-06)</span>
<span class=sd>    (-1, 500000)</span>
<span class=sd>    >>> -1 / 500000</span>
<span class=sd>    -2e-06</span>

<span class=sd>    >>> float_to_frac(-6e-08)</span>
<span class=sd>    (-3, 50000000)</span>
<span class=sd>    >>> -3 / 50000000</span>
<span class=sd>    -6e-08</span>

<span class=sd>    >>> float_to_frac(7e-05)</span>
<span class=sd>    (7, 100000)</span>
<span class=sd>    >>> 7 / 100000</span>
<span class=sd>    7e-05</span>

<span class=sd>    >>> float_to_frac(-1e+40)</span>
<span class=sd>    (-10000000000000000000000000000000000000000, 1)</span>
<span class=sd>    >>> -10000000000000000000000000000000000000000 / 1</span>
<span class=sd>    -1e+40</span>

<span class=sd>    >>> float_to_frac(1e+40)</span>
<span class=sd>    (10000000000000000000000000000000000000000, 1)</span>
<span class=sd>    >>> 10000000000000000000000000000000000000000 / 1</span>
<span class=sd>    1e+40</span>
<span class=sd>    """</span>
    <span class=n>value</span> <span class=o>=</span> <span class=n>try_int</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>value</span><span class=p>,</span> <span class=mi>1</span>

    <span class=c1># First, we convert the floating point number to a string, which</span>
    <span class=c1># necessarily exactly represents the value. Then we will go and turn</span>
    <span class=c1># the string into a fraction.</span>
    <span class=n>value_str</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=nb>float</span><span class=o>.</span><span class=fm>__repr__</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
    <span class=n>minus</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=n>value_str</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s2>"-"</span>

    <span class=n>start_idx</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span> <span class=k>if</span> <span class=n>minus</span> <span class=k>else</span> <span class=mi>0</span>
    <span class=n>end_idx</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=nb>str</span><span class=o>.</span><span class=fm>__len__</span><span class=p>(</span><span class=n>value_str</span><span class=p>)</span>
    <span class=n>dot_idx</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=nb>str</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=n>value_str</span><span class=p>,</span> <span class=s2>"."</span><span class=p>)</span>
    <span class=n>exp_idx</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=nb>str</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=n>value_str</span><span class=p>,</span> <span class=s2>"e"</span><span class=p>)</span>

    <span class=n>int_denominator</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span>
    <span class=n>int_multiplier</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span>
    <span class=k>if</span> <span class=n>exp_idx</span> <span class=o>></span> <span class=mi>0</span><span class=p>:</span>
        <span class=n>int_exp</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>value_str</span><span class=p>[</span><span class=n>exp_idx</span> <span class=o>+</span> <span class=mi>1</span><span class=p>:</span><span class=n>end_idx</span><span class=p>])</span>
        <span class=k>if</span> <span class=n>int_exp</span> <span class=o><</span> <span class=mi>0</span><span class=p>:</span>
            <span class=n>int_denominator</span> <span class=o>=</span> <span class=mi>10</span> <span class=o>**</span> <span class=p>(</span><span class=o>-</span><span class=n>int_exp</span><span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>int_multiplier</span> <span class=o>=</span> <span class=mi>10</span> <span class=o>**</span> <span class=n>int_exp</span>
        <span class=n>end_idx</span> <span class=o>=</span> <span class=n>exp_idx</span>

    <span class=n>int_numerator</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=k>if</span> <span class=n>dot_idx</span> <span class=o>>=</span> <span class=mi>0</span><span class=p>:</span>
        <span class=n>int_denom_2</span> <span class=o>=</span> <span class=mi>10</span> <span class=o>**</span> <span class=p>(</span><span class=n>end_idx</span> <span class=o>-</span> <span class=n>dot_idx</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
        <span class=n>int_numerator</span> <span class=o>=</span> <span class=p>((</span><span class=nb>int</span><span class=p>(</span><span class=n>value_str</span><span class=p>[</span><span class=n>start_idx</span><span class=p>:</span><span class=n>dot_idx</span><span class=p>])</span> <span class=o>*</span> <span class=n>int_denom_2</span><span class=p>)</span>
                         <span class=o>+</span> <span class=nb>int</span><span class=p>(</span><span class=n>value_str</span><span class=p>[</span><span class=n>dot_idx</span> <span class=o>+</span> <span class=mi>1</span><span class=p>:</span><span class=n>end_idx</span><span class=p>]))</span>
        <span class=n>int_denominator</span> <span class=o>*=</span> <span class=n>int_denom_2</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>int_numerator</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>value_str</span><span class=p>[</span><span class=n>start_idx</span><span class=p>:</span><span class=n>end_idx</span><span class=p>])</span>

    <span class=n>int_numerator</span> <span class=o>*=</span> <span class=n>int_multiplier</span>
    <span class=n>divi</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>gcd</span><span class=p>(</span><span class=n>int_numerator</span><span class=p>,</span> <span class=n>int_denominator</span><span class=p>)</span>
    <span class=n>int_numerator</span> <span class=o>//=</span> <span class=n>divi</span>
    <span class=n>int_denominator</span> <span class=o>//=</span> <span class=n>divi</span>

    <span class=n>int_denom_2</span> <span class=o>=</span> <span class=n>int_denominator</span>
    <span class=k>if</span> <span class=n>minus</span><span class=p>:</span>  <span class=c1># pack the minus back into the numerator, if needed</span>
        <span class=n>int_numerator</span> <span class=o>=</span> <span class=o>-</span><span class=n>int_numerator</span>

    <span class=c1># This is the default way that produces exact fractional representations</span>
    <span class=c1># based on the binary layout. We will prefer this way, unless the</span>
    <span class=c1># string-based approach delivers a more compact fraction.</span>
    <span class=n>alt_numer</span><span class=p>,</span> <span class=n>alt_denom</span> <span class=o>=</span> <span class=n>value</span><span class=o>.</span><span class=n>as_integer_ratio</span><span class=p>()</span>
    <span class=k>if</span> <span class=p>((</span><span class=n>int_numerator</span> <span class=o>/</span> <span class=n>int_denominator</span><span class=p>)</span> <span class=o>!=</span> <span class=n>value</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span>
            <span class=p>(</span><span class=n>alt_denom</span> <span class=o><=</span> <span class=n>int_denominator</span><span class=p>)</span> <span class=ow>and</span> <span class=p>(</span>
            <span class=p>(</span><span class=n>alt_denom</span> <span class=o><</span> <span class=n>int_denominator</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=nb>abs</span><span class=p>(</span>
            <span class=n>alt_numer</span><span class=p>)</span> <span class=o><</span> <span class=n>int_denom_2</span><span class=p>))):</span>
        <span class=c1># We stick with the default, unless it leads to verbose fractions.</span>
        <span class=k>return</span> <span class=n>alt_numer</span><span class=p>,</span> <span class=n>alt_denom</span>

    <span class=k>return</span> <span class=n>int_numerator</span><span class=p>,</span> <span class=n>int_denominator</span></div>



<div class=viewcode-block id=try_int_div>
<a class=viewcode-back href=../../../pycommons.math.html#pycommons.math.int_math.try_int_div>[docs]</a>
<span class=k>def</span><span class=w> </span><span class=nf>try_int_div</span><span class=p>(</span><span class=n>a</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>b</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-></span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Try to divide two integers at best precision.</span>

<span class=sd>    Floating point divisions can incur some loss of precision. We try</span>
<span class=sd>    to avoid this here as much as possible. First, we check if `a` is</span>
<span class=sd>    divisible by `b` without any fractional part. If this is true, then</span>
<span class=sd>    we can do a pure integer division without loss of any precision.</span>
<span class=sd>    In other words, if `a % b == 0`, then `a / b` is itself an integer,</span>
<span class=sd>    i.e., can be represented exactly.</span>

<span class=sd>    Otherwise, it will have a fractional part, so it would ideally be a</span>
<span class=sd>    `float`.</span>
<span class=sd>    Well.</span>

<span class=sd>    What if the integer `a` is  really large? Converting it to floating</span>
<span class=sd>    point number may then incur a loss of precision. And why do we convert</span>
<span class=sd>    it to a `float` in the first place? To properly represent the fractional</span>
<span class=sd>    part. Because the integer part is `a // b` is an integer. The fractional</span>
<span class=sd>    part `f` is then by definition `f = (a % b) // b == (a - b*(a // b)) / b`.</span>
<span class=sd>    Obviously, `0&LTf&LT1`. It may be entirely possible that we lose several full</span>
<span class=sd>    integer *digits* by converting the integer `a` to a `float` ... just to</span>
<span class=sd>    then be able to add a fraction `f`. So this loss of precision may be much</span>
<span class=sd>    larger than the little fractional part that we would add (which will</span>
<span class=sd>    always be in `(0, 1)`. In such a case, it may be much better to stay in</span>
<span class=sd>    the realm of integers and instead lose the fractional part. Thus, we also</span>
<span class=sd>    test whether multiplying the result of the floating point computation with</span>
<span class=sd>    `b` is closer to `a` than integer results rounded in either direction.</span>

<span class=sd>    During this procedure, we try to pick the result closest to the original</span>
<span class=sd>    value. This, however, may only be possible if we can actually compute the</span>
<span class=sd>    difference. If we deal with floating point numbers and integers, some</span>
<span class=sd>    integers may simply be too large for being ever converted to a float. In</span>
<span class=sd>    this case, we remain entirely in the integer realm and only round if need</span>
<span class=sd>    be.</span>

<span class=sd>    :param a: the first integer</span>
<span class=sd>    :param b: the second integer</span>
<span class=sd>    :returns: a/b, either as `int` or as `float` but always a finite value</span>
<span class=sd>    :raises ZeroDivisionError: if `b==0`</span>
<span class=sd>    :raises TypeError: if `a` or `b` are not integers</span>

<span class=sd>    >>> print(try_int_div(10, 2))</span>
<span class=sd>    5</span>
<span class=sd>    >>> print(try_int_div(10, -2))</span>
<span class=sd>    -5</span>
<span class=sd>    >>> print(try_int_div(-10, 2))</span>
<span class=sd>    -5</span>
<span class=sd>    >>> print(try_int_div(-10, -2))</span>
<span class=sd>    5</span>
<span class=sd>    >>> print(type(try_int_div(10, 2)))</span>
<span class=sd>    &LTclass 'int'></span>
<span class=sd>    >>> print(try_int_div(10, 3))</span>
<span class=sd>    3.3333333333333335</span>
<span class=sd>    >>> print(try_int_div(-10, 3))</span>
<span class=sd>    -3.3333333333333335</span>
<span class=sd>    >>> print(try_int_div(10, -3))</span>
<span class=sd>    -3.3333333333333335</span>
<span class=sd>    >>> print(try_int_div(-10, -3))</span>
<span class=sd>    3.3333333333333335</span>
<span class=sd>    >>> print(type(try_int_div(10, 3)))</span>
<span class=sd>    &LTclass 'float'></span>
<span class=sd>    >>> print(try_int_div(9007199254740992, 1))</span>
<span class=sd>    9007199254740992</span>
<span class=sd>    >>> print(try_int_div(2109792310235001520128, 234234))</span>
<span class=sd>    9007199254740992</span>
<span class=sd>    >>> print(try_int_div(2109792310235001520128, 234235))</span>
<span class=sd>    9007160801054503</span>
<span class=sd>    >>> print(try_int_div(2109792310235001520128, 234233))</span>
<span class=sd>    9007237708755818</span>
<span class=sd>    >>> large = 123456789012345678901234567890123456789012345678901234567\</span>
<span class=sd>89012345678901234567890123456789012345678901234567890123456789012345678901234\</span>
<span class=sd>56789012345678901234567890123456789012345678901234567890123456789012345678901\</span>
<span class=sd>23456789012345678901234567890123456789012345678901234567890123456789012345678\</span>
<span class=sd>90123456789012345678901234567890123456789012345678901234567890123456789012345\</span>
<span class=sd>67890123456789012345678901234567890123456789012345678901234567890123456789012\</span>
<span class=sd>3456789012345678901234567890123456789012345678901234567890123456789012345678\</span>
<span class=sd>90123456789012345678901234567890123456789012345678901234567890123456789012345\</span>
<span class=sd>678901234567890123456789012345678901234567890</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     large / 1</span>
<span class=sd>    ... except OverflowError as oe:</span>
<span class=sd>    ...     print(oe)</span>
<span class=sd>    integer division result too large for a float</span>
<span class=sd>    >>> try_int_div(large, 1)</span>
<span class=sd>    123456789012345678901234567890123456789012345678901234567\</span>
<span class=sd>89012345678901234567890123456789012345678901234567890123456789012345678901234\</span>
<span class=sd>56789012345678901234567890123456789012345678901234567890123456789012345678901\</span>
<span class=sd>23456789012345678901234567890123456789012345678901234567890123456789012345678\</span>
<span class=sd>90123456789012345678901234567890123456789012345678901234567890123456789012345\</span>
<span class=sd>67890123456789012345678901234567890123456789012345678901234567890123456789012\</span>
<span class=sd>3456789012345678901234567890123456789012345678901234567890123456789012345678\</span>
<span class=sd>90123456789012345678901234567890123456789012345678901234567890123456789012345\</span>
<span class=sd>678901234567890123456789012345678901234567890</span>

<span class=sd>    >>> try_int_div(large * 7, 1 * 7)</span>
<span class=sd>    123456789012345678901234567890123456789012345678901234567\</span>
<span class=sd>89012345678901234567890123456789012345678901234567890123456789012345678901234\</span>
<span class=sd>56789012345678901234567890123456789012345678901234567890123456789012345678901\</span>
<span class=sd>23456789012345678901234567890123456789012345678901234567890123456789012345678\</span>
<span class=sd>90123456789012345678901234567890123456789012345678901234567890123456789012345\</span>
<span class=sd>67890123456789012345678901234567890123456789012345678901234567890123456789012\</span>
<span class=sd>3456789012345678901234567890123456789012345678901234567890123456789012345678\</span>
<span class=sd>90123456789012345678901234567890123456789012345678901234567890123456789012345\</span>
<span class=sd>678901234567890123456789012345678901234567890</span>

<span class=sd>    >>> res = try_int_div(large, 7)</span>
<span class=sd>    >>> print(res)</span>
<span class=sd>    1763668414462081127160493827001763668414462081127160493827001763668414462\</span>
<span class=sd>08112716049382700176366841446208112716049382700176366841446208112716049382700\</span>
<span class=sd>17636684144620811271604938270017636684144620811271604938270017636684144620811\</span>
<span class=sd>27160493827001763668414462081127160493827001763668414462081127160493827001763\</span>
<span class=sd>66841446208112716049382700176366841446208112716049382700176366841446208112716\</span>
<span class=sd>04938270017636684144620811271604938270017636684144620811271604938270017636684\</span>
<span class=sd>14462081127160493827001763668414462081127160493827001763668414462081127160493\</span>
<span class=sd>82700176366841446208112716049382700176366841446208112716049382700176366841446\</span>
<span class=sd>208112716049382700176366841</span>
<span class=sd>    >>> large - (res * 7)</span>
<span class=sd>    3</span>

<span class=sd>    >>> res = try_int_div(large - 1, 7)</span>
<span class=sd>    >>> print(res)</span>
<span class=sd>    1763668414462081127160493827001763668414462081127160493827001763668414462\</span>
<span class=sd>08112716049382700176366841446208112716049382700176366841446208112716049382700\</span>
<span class=sd>17636684144620811271604938270017636684144620811271604938270017636684144620811\</span>
<span class=sd>27160493827001763668414462081127160493827001763668414462081127160493827001763\</span>
<span class=sd>66841446208112716049382700176366841446208112716049382700176366841446208112716\</span>
<span class=sd>04938270017636684144620811271604938270017636684144620811271604938270017636684\</span>
<span class=sd>14462081127160493827001763668414462081127160493827001763668414462081127160493\</span>
<span class=sd>82700176366841446208112716049382700176366841446208112716049382700176366841446\</span>
<span class=sd>208112716049382700176366841</span>
<span class=sd>    >>> (large - 1) - (res * 7)</span>
<span class=sd>    2</span>

<span class=sd>    >>> res = try_int_div(large + 1, 7)</span>
<span class=sd>    >>> print(res)</span>
<span class=sd>    1763668414462081127160493827001763668414462081127160493827001763668414462\</span>
<span class=sd>08112716049382700176366841446208112716049382700176366841446208112716049382700\</span>
<span class=sd>17636684144620811271604938270017636684144620811271604938270017636684144620811\</span>
<span class=sd>27160493827001763668414462081127160493827001763668414462081127160493827001763\</span>
<span class=sd>66841446208112716049382700176366841446208112716049382700176366841446208112716\</span>
<span class=sd>04938270017636684144620811271604938270017636684144620811271604938270017636684\</span>
<span class=sd>14462081127160493827001763668414462081127160493827001763668414462081127160493\</span>
<span class=sd>82700176366841446208112716049382700176366841446208112716049382700176366841446\</span>
<span class=sd>208112716049382700176366842</span>
<span class=sd>    >>> (large + 1) - (res * 7)</span>
<span class=sd>    -3</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_int_div(0, 0)</span>
<span class=sd>    ... except ZeroDivisionError as zde:</span>
<span class=sd>    ...     print(zde)</span>
<span class=sd>    integer division or modulo by zero</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_int_div(1, 0)</span>
<span class=sd>    ... except ZeroDivisionError as zde:</span>
<span class=sd>    ...     print(zde)</span>
<span class=sd>    integer division or modulo by zero</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_int_div(-1, 0)</span>
<span class=sd>    ... except ZeroDivisionError as zde:</span>
<span class=sd>    ...     print(zde)</span>
<span class=sd>    integer division or modulo by zero</span>

<span class=sd>    >>> try_int_div(153, 17)</span>
<span class=sd>    9</span>
<span class=sd>    >>> try_int_div(-153, 17)</span>
<span class=sd>    -9</span>
<span class=sd>    >>> try_int_div(626240198453350272215815210991, 180)</span>
<span class=sd>    3479112213629723734532306728</span>
<span class=sd>    >>> try_int_div(-626240198453350272215815210991, 180)</span>
<span class=sd>    -3479112213629723734532306728</span>
<span class=sd>    >>> try_int_div(312641328808813509022862142116, 184)</span>
<span class=sd>    1699137656569638635993815990</span>
<span class=sd>    >>> try_int_div(-312641328808813509022862142116, 184)</span>
<span class=sd>    -1699137656569638635993815990</span>
<span class=sd>    >>> try_int_div(300228563787891776398328530521, 6)</span>
<span class=sd>    50038093964648629399721421754</span>
<span class=sd>    >>> try_int_div(300228563787891776398328530520, 6)</span>
<span class=sd>    50038093964648629399721421753</span>
<span class=sd>    >>> try_int_div(-300228563787891776398328530521, 6)</span>
<span class=sd>    -50038093964648629399721421754</span>

<span class=sd>    >>> try_int_div(153, -17)</span>
<span class=sd>    -9</span>
<span class=sd>    >>> try_int_div(-153, -17)</span>
<span class=sd>    9</span>
<span class=sd>    >>> try_int_div(626240198453350272215815210991, -180)</span>
<span class=sd>    -3479112213629723734532306728</span>
<span class=sd>    >>> try_int_div(-626240198453350272215815210991, -180)</span>
<span class=sd>    3479112213629723734532306728</span>
<span class=sd>    >>> try_int_div(312641328808813509022862142116, -184)</span>
<span class=sd>    -1699137656569638635993815990</span>
<span class=sd>    >>> try_int_div(-312641328808813509022862142116, -184)</span>
<span class=sd>    1699137656569638635993815990</span>
<span class=sd>    >>> try_int_div(300228563787891776398328530521, -6)</span>
<span class=sd>    -50038093964648629399721421754</span>
<span class=sd>    >>> try_int_div(-300228563787891776398328530521, -6)</span>
<span class=sd>    50038093964648629399721421754</span>

<span class=sd>    >>> try_int_div(471560594207063922064065980174, 160)</span>
<span class=sd>    2947253713794149512900412376</span>

<span class=sd>    >>> try_int_div(7995687632, 605623302520652727304862084393)</span>
<span class=sd>    1.3202410803417417e-20</span>

<span class=sd>    >>> try_int_div(308201705551808339041017943851, 23)</span>
<span class=sd>    13400074154426449523522519298</span>

<span class=sd>    >>> try_int_div(899348944156468188933109403939, 54)</span>
<span class=sd>    16654610076971633128390914888</span>

<span class=sd>    >>> try_int_div(494818043590514116668712249977, 42)</span>
<span class=sd>    11781381990250336111159815476</span>

<span class=sd>    >>> try_int_div(738070379515233920, 205)</span>
<span class=sd>    3600343314708458</span>

<span class=sd>    >>> try_int_div(3502315235185234554036893628, 2914324106703)</span>
<span class=sd>    1201759003787480</span>

<span class=sd>    >>> try_int_div(7410628973168661103, 3869)</span>
<span class=sd>    1915386139356076.8</span>

<span class=sd>    >>> try_int_div(1230161216449799063065724370370, 4689247521470)</span>
<span class=sd>    262336592559346126</span>

<span class=sd>    >>> try_int_div(1052870426843577701006624798274, 28)</span>
<span class=sd>    37602515244413489321665171367</span>

<span class=sd>    >>> try_int_div(218235816140080518429116, 65180391)</span>
<span class=sd>    3348182065064330.5</span>

<span class=sd>    >>> try_int_div(542681063252950460111634072, 1417)</span>
<span class=sd>    382978873149576894927053</span>

<span class=sd>    >>> try_int_div(6347580784084238615827, 9508617)</span>
<span class=sd>    667560885466754.9</span>

<span class=sd>    >>> try_int_div(25864142832167873073008, 8621014)</span>
<span class=sd>    3000127691727199.5</span>

<span class=sd>    >>> try_int_div(35377667634669293542601414338, 8678403583)</span>
<span class=sd>    4076517909811212054</span>

<span class=sd>    >>> try_int_div(1423204593957046760175, 6)</span>
<span class=sd>    237200765659507793363</span>

<span class=sd>    >>> try_int_div(1959151753859121847452742, 155502)</span>
<span class=sd>    12598884605079817928</span>

<span class=sd>    >>> try_int_div(153429321515534965993379305, 15165212220)</span>
<span class=sd>    10117189215010864</span>

<span class=sd>    >>> try_int_div(638685779810794590594721888599, 6355644831674)</span>
<span class=sd>    100491106209686119</span>

<span class=sd>    >>> try_int_div(14634805, 3163458943542033136)</span>
<span class=sd>    4.626203551614245e-12</span>

<span class=sd>    >>> try_int_div(2728490692514068837390, 1134)</span>
<span class=sd>    2406076448425104795</span>

<span class=sd>    >>> try_int_div(52133244, 2145832361321597595907)</span>
<span class=sd>    2.4295115005112346e-14</span>

<span class=sd>    >>> try_int_div(989732710522254024, 870)</span>
<span class=sd>    1137623805197993.2</span>

<span class=sd>    >>> try_int_div(1015, 4100715151904)</span>
<span class=sd>    2.475178017494646e-10</span>

<span class=sd>    >>> try_int_div(750731, 60649291746)</span>
<span class=sd>    1.2378231936228884e-05</span>

<span class=sd>    >>> try_int_div(7972413701754221571302566, 1660418690)</span>
<span class=sd>    4801447821425222</span>

<span class=sd>    >>> try_int_div(356135676699525125944, 46208)</span>
<span class=sd>    7707229845471025</span>

<span class=sd>    >>> try_int_div(10448177882855961291672, 1739414)</span>
<span class=sd>    6006722886475538</span>

<span class=sd>    >>> try_int_div(739391142068058031063862, 8456)</span>
<span class=sd>    87439822855730609161</span>

<span class=sd>    >>> try_int_div(316514845935646909034735039673, 32172)</span>
<span class=sd>    9838208564455020173900753</span>

<span class=sd>    >>> try_int_div(4158458869534984918534998087, 30)</span>
<span class=sd>    138615295651166163951166603</span>

<span class=sd>    >>> try_int_div(102306108211747181839762853503, 29118)</span>
<span class=sd>    3513500522417308257427119</span>

<span class=sd>    >>> all(try_int_div(1, y) == (1 / y) for y in range(2, 10))</span>
<span class=sd>    True</span>

<span class=sd>    >>> all(try_int_div(2, y) == (2 / y) for y in range(3, 10))</span>
<span class=sd>    True</span>

<span class=sd>    >>> try_int_div(820432337843942760, 85)</span>
<span class=sd>    9652145151105209</span>

<span class=sd>    >>> try_int_div(84050617, 3577089862)</span>
<span class=sd>    0.023496926340286613</span>

<span class=sd>    >>> try_int_div(812060021745358856, 996816531)</span>
<span class=sd>    814653445.7356013</span>

<span class=sd>    >>> try_int_div(38029336, 472982612237)</span>
<span class=sd>    8.040324319775297e-05</span>

<span class=sd>    >>> try_int_div(50229909719349513, 9)</span>
<span class=sd>    5581101079927724</span>

<span class=sd>    >>> try_int_div(61320503685013026, 2728161164469337)</span>
<span class=sd>    22.476862614874392</span>

<span class=sd>    >>> try_int_div(23134400382350491, 8)</span>
<span class=sd>    2891800047793811.5</span>

<span class=sd>    >>> try_int_div(12510965, 67561917605841203)</span>
<span class=sd>    1.8517776645993746e-10</span>

<span class=sd>    >>> try_int_div(27246707584980173, 4)</span>
<span class=sd>    6811676896245043</span>

<span class=sd>    >>> try_int_div(135385235231741420, 6)</span>
<span class=sd>    22564205871956903</span>

<span class=sd>    >>> try_int_div(90, 153429501803)</span>
<span class=sd>    5.865886217603572e-10</span>

<span class=sd>    >>> try_int_div(734553401849288248, 951111)</span>
<span class=sd>    772310909924.5916</span>

<span class=sd>    >>> try_int_div(9820998979656, 4239082999146)</span>
<span class=sd>    2.3167744018304255</span>

<span class=sd>    >>> try_int_div(133105116441194557, 17)</span>
<span class=sd>    7829712731834974</span>

<span class=sd>    >>> try_int_div(1004604250960040176, 14)</span>
<span class=sd>    71757446497145727</span>

<span class=sd>    >>> try_int_div(246148731190755584, 6)</span>
<span class=sd>    41024788531792597</span>

<span class=sd>    >>> try_int_div(991564, 72057594037927936)</span>
<span class=sd>    1.3760714789867734e-11</span>

<span class=sd>    >>> try_int_div(2623725286393384, 139634775865757)</span>
<span class=sd>    18.789912972079378</span>

<span class=sd>    >>> try_int_div(63010439554808723, 9)</span>
<span class=sd>    7001159950534303</span>

<span class=sd>    >>> try_int_div(2801452, 427673)</span>
<span class=sd>    6.550453266865105</span>

<span class=sd>    >>> try_int_div(14177411351567, 349688426689780)</span>
<span class=sd>    0.04054298132132421</span>

<span class=sd>    >>> try_int_div(126660394112336947, 368)</span>
<span class=sd>    344185853566133</span>

<span class=sd>    >>> try_int_div(1031427640916897886, 7)</span>
<span class=sd>    147346805845271127</span>

<span class=sd>    >>> try_int_div(33290935002573849, 2)</span>
<span class=sd>    16645467501286925</span>

<span class=sd>    >>> try_int_div(209062743096233332, 64)</span>
<span class=sd>    3266605360878646</span>

<span class=sd>    >>> try_int_div(253174817711179642, 57)</span>
<span class=sd>    4441663468617186.5</span>

<span class=sd>    >>> try_int_div(29462133006911895, 24943246)</span>
<span class=sd>    1181166757.8033707</span>

<span class=sd>    >>> try_int_div(93475849985676023, 60673699562)</span>
<span class=sd>    1540632.1134276118</span>

<span class=sd>    >>> try_int_div(-16, -16)</span>
<span class=sd>    1</span>

<span class=sd>    >>> try_int_div(242, 150)</span>
<span class=sd>    1.6133333333333333</span>

<span class=sd>    >>> try_int_div(-547, -698)</span>
<span class=sd>    0.7836676217765043</span>

<span class=sd>    >>> try_int_div(463, 105)</span>
<span class=sd>    4.40952380952381</span>

<span class=sd>    >>> try_int_div(-148, -203)</span>
<span class=sd>    0.729064039408867</span>

<span class=sd>    >>> try_int_div(0, -25)</span>
<span class=sd>    0</span>

<span class=sd>    >>> try_int_div(24, -177)</span>
<span class=sd>    -0.13559322033898305</span>

<span class=sd>    >>> try_int_div(-166, 186)</span>
<span class=sd>    -0.8924731182795699</span>

<span class=sd>    >>> try_int_div(-608143760099358008316, 16)</span>
<span class=sd>    -38008985006209875520</span>

<span class=sd>    >>> try_int_div(-6917198296130591233, 2932)</span>
<span class=sd>    -2359208150112753</span>

<span class=sd>    >>> try_int_div(-40068404846647758412, 2431)</span>
<span class=sd>    -16482272664190769</span>

<span class=sd>    >>> try_int_div(809884532216820092, -80)</span>
<span class=sd>    -10123556652710251</span>

<span class=sd>    >>> try_int_div(-9428902965475478968, -1946)</span>
<span class=sd>    4845273877428304</span>

<span class=sd>    >>> try_int_div(94881103250893722164, 174)</span>
<span class=sd>    545293696844216794</span>

<span class=sd>    >>> try_int_div(558275776531402194, 196)</span>
<span class=sd>    2848345798629603</span>

<span class=sd>    >>> try_int_div(-5470954588630039684, -1425)</span>
<span class=sd>    3839266377985993</span>

<span class=sd>    >>> x = 52051907638184435686872083537997907834107397007408814104887055550\</span>
<span class=sd>62651162584515572343506336421788506498764827396236326664325857298113627143047\</span>
<span class=sd>51960058116028166468699987611855171916670918181477368243402962224866666859483\</span>
<span class=sd>27106641344727853102203836313167806475289935694133683049416723665601922267867\</span>
<span class=sd>43423073756386687744959209264639678418438341653942959851578625489694262628828\</span>
<span class=sd>01502680997461128779292890987864647476268814586685317933377503211673153129336\</span>
<span class=sd>03</span>
<span class=sd>    >>> y = -1390354761575126197823721816501267487365151253235077143453455350\</span>
<span class=sd>42071715351921681111638693456863646113210365045493352</span>
<span class=sd>    >>> try_int_div(x, y)</span>
<span class=sd>    -374378605207314720094873468836285633819929467061778300817269205498029513\</span>
<span class=sd>65402433513265745971266615921400317429877366670340545494622384105823993306348\</span>
<span class=sd>52843139170606054848072439314573682429224161889047753873201343420620892557508\</span>
<span class=sd>62700497112616274728625215898978448963212698759159253800300962780904741771804\</span>
<span class=sd>645167943738988195771748632862162</span>

<span class=sd>    >>> x = -2371099749665044990658141554075074237566818135879925492767658755\</span>
<span class=sd>91466431785344954996723447284617738104563308335316636469414432945133872626562\</span>
<span class=sd>47514537471872530515191642703803616012611248118482218872482697827387761273565\</span>
<span class=sd>86825000794528611072492997052827719254891404531142028847153355973782623685875\</span>
<span class=sd>55388033455119839506838214696423221276537787120528956164822252461892023157114\</span>
<span class=sd>02799038227958323905920667727058869625829951896827916647011550854954614174228\</span>
<span class=sd>0327582498733595995697631187168710055335569609973997123439124471957303314220</span>
<span class=sd>    >>> y = 23343578649740692313745114608806472033684574464287511781560680643\</span>
<span class=sd>78701796266433578371331497</span>
<span class=sd>    >>> try_int_div(x, y)</span>
<span class=sd>    -101573961098350440775039372298606794268469908577045401233130406288914282\</span>
<span class=sd>92918893248309802232281829255680862092165642164462698933290177430764947955661\</span>
<span class=sd>87652857199541665161754173953190591131037518696771010612358486878465958542091\</span>
<span class=sd>54914381056640460582835505879418330902968200425941036454902030259440742425865\</span>
<span class=sd>93440206970165106076445287259870479244010983474198088053313334979762284802017\</span>
<span class=sd>1153886834216445854191456742632611734684212485945595091</span>

<span class=sd>    >>> x = 40410061884642793201602670149115414017394734761323545080847020296\</span>
<span class=sd>25252534757283636685784303675489231680221820894136736092474359799408796002401\</span>
<span class=sd>87921742390653841150636438854369236710256224057607718115525186887758631639670\</span>
<span class=sd>82468402380054839668544662058030344964306015945683011983835531538788295592437\</span>
<span class=sd>65716882229369219075665520432950975969718863463181388344946182200519006147179\</span>
<span class=sd>64461315530742161850062785306859778524746068148875909170944464910610460508750\</span>
<span class=sd>707051996751159775959805908309</span>
<span class=sd>    >>> try_int_div(x, 455824846955327759894405021890034373481341853483437732)</span>
<span class=sd>    8865260890133771894279961299939580714408739728863480476996077470796169955\</span>
<span class=sd>43085620471927592765951912973058793385603301586629745150439814928912960267883\</span>
<span class=sd>66400412702824502182496145839556516762964408587815797906905800899307550385283\</span>
<span class=sd>59797468484699310297417864757571840405529641545438878013277855865542975695833\</span>
<span class=sd>88146919245416237227940140677498927052487483630425657258239092995434299050034\</span>
<span class=sd>021769275549143357256693312576946435784210430</span>

<span class=sd>    >>> x = -6232936786190843094006005233017695847240511752635979691082519622\</span>
<span class=sd>89671822451515008492890632740917254159586399372900046205300278719490624751881\</span>
<span class=sd>76026655230475873682972201137642189143060727745274448518821915960488822897219\</span>
<span class=sd>19105433159267999911968464110051361652323090653411336081715581855840751539611\</span>
<span class=sd>44549510551090842769903146173949669899963195645511983189442245054559694895154\</span>
<span class=sd>28690282113755080383328799009405959846487733552322199361433571441631699077621\</span>
<span class=sd>235779724223724145601506861527256455350316142</span>
<span class=sd>    >>> y = -672227780379448967615099076221459579351218967417588220</span>
<span class=sd>    >>> try_int_div(x, y)</span>
<span class=sd>    9272060703401113879042492429626067042706252670698636022710487050821126676\</span>
<span class=sd>43853746484009770979124008642489211907343513622775392767108564692587266167738\</span>
<span class=sd>93885766234994122772733590708011238049750176667082969644614903930265971589853\</span>
<span class=sd>26674807243894898200722561326294551914700598739493395761954564220400052036328\</span>
<span class=sd>58909594484124974270252599224045683880122299500249240856446063861849302671425\</span>
<span class=sd>05617327729864850535306650812894643758024556770793387750201</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_int_div(1.0, 2)</span>
<span class=sd>    ... except TypeError as te:</span>
<span class=sd>    ...     print(te)</span>
<span class=sd>    a should be an instance of int but is float, namely 1.0.</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_int_div(1, 2.0)</span>
<span class=sd>    ... except TypeError as te:</span>
<span class=sd>    ...     print(te)</span>
<span class=sd>    b should be an instance of int but is float, namely 2.0.</span>
<span class=sd>    """</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=s2>"a"</span><span class=p>,</span> <span class=nb>int</span><span class=p>)</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=s2>"b"</span><span class=p>,</span> <span class=nb>int</span><span class=p>)</span>
    <span class=n>minus</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span>
    <span class=k>if</span> <span class=n>a</span> <span class=o><</span> <span class=mi>0</span><span class=p>:</span>
        <span class=n>minus</span> <span class=o>=</span> <span class=kc>True</span>
        <span class=n>a</span> <span class=o>=</span> <span class=o>-</span><span class=n>a</span>
    <span class=k>if</span> <span class=n>b</span> <span class=o><</span> <span class=mi>0</span><span class=p>:</span>
        <span class=n>minus</span> <span class=o>=</span> <span class=ow>not</span> <span class=n>minus</span>
        <span class=n>b</span> <span class=o>=</span> <span class=o>-</span><span class=n>b</span>

    <span class=c1># Let's say a = 762 and b = 204.</span>
    <span class=c1># We first compute the GCD to reduce both sides of the equation.</span>
    <span class=n>the_gcd</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>gcd</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>)</span>  <span class=c1># == 6 in the example</span>
    <span class=n>a</span> <span class=o>//=</span> <span class=n>the_gcd</span>  <span class=c1># == 127 in the example</span>
    <span class=n>b</span> <span class=o>//=</span> <span class=n>the_gcd</span>  <span class=c1># == 34 in the example</span>

    <span class=c1># First, let's compute the result of the pure integer division.</span>
    <span class=n>int_res_1</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>a</span> <span class=o>//</span> <span class=n>b</span>  <span class=c1># == 3 in our example</span>
    <span class=n>int_mult_1</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>int_res_1</span> <span class=o>*</span> <span class=n>b</span>  <span class=c1># == 102 in the example</span>
    <span class=k>if</span> <span class=n>int_mult_1</span> <span class=o>==</span> <span class=n>a</span><span class=p>:</span>  <span class=c1># if there is no rest, then we can stop here</span>
        <span class=k>return</span> <span class=o>-</span><span class=n>int_res_1</span> <span class=k>if</span> <span class=n>minus</span> <span class=k>else</span> <span class=n>int_res_1</span>

    <span class=n>int_frac_1</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>a</span> <span class=o>-</span> <span class=n>int_mult_1</span>  <span class=c1># == 25 in the example</span>
    <span class=n>int_res_2</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>int_res_1</span> <span class=o>+</span> <span class=mi>1</span>  <span class=c1># rounding up, == 4 in the example</span>
    <span class=c1># Compute int_frac_2 == (int_res_2 * b - a, but simplified:</span>
    <span class=n>int_frac_2</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>b</span> <span class=o>-</span> <span class=n>int_frac_1</span>  <span class=c1># == 9 in the example</span>

    <span class=c1># OK, there may be a loss of precision if we do the floating point</span>
    <span class=c1># computation. But we should try it now anyway.</span>
    <span class=c1># if `a` and `b` can exactly be represented as floats (by being not more</span>
    <span class=c1># than `__DBL_INT_LIMIT_P_I`, then we are OK and can directly use the</span>
    <span class=c1># result. Otherwise, if the result is between the lower and the upper</span>
    <span class=c1># limit, then we will also take it. This would mean to basically default</span>
    <span class=c1># to the normal division in Python in cases where it falls into the</span>
    <span class=c1># expected range of possible results.</span>
    <span class=k>with</span> <span class=n>suppress</span><span class=p>(</span><span class=ne>ArithmeticError</span><span class=p>):</span>
        <span class=n>float_res</span> <span class=o>=</span> <span class=n>__try_int</span><span class=p>(</span><span class=n>a</span> <span class=o>/</span> <span class=n>b</span><span class=p>)</span>  <span class=c1># == 3.5588235294117645 in the example</span>
        <span class=k>if</span> <span class=p>((</span><span class=n>a</span> <span class=o><=</span> <span class=n>__DBL_INT_LIMIT_P_I</span><span class=p>)</span> <span class=ow>and</span> <span class=p>(</span><span class=n>b</span> <span class=o><=</span> <span class=n>__DBL_INT_LIMIT_P_I</span><span class=p>))</span> <span class=ow>or</span> <span class=p>(</span>
                <span class=n>int_res_1</span> <span class=o><</span> <span class=n>float_res</span> <span class=o><</span> <span class=n>int_res_2</span><span class=p>):</span>
            <span class=k>return</span> <span class=o>-</span><span class=n>float_res</span> <span class=k>if</span> <span class=n>minus</span> <span class=k>else</span> <span class=n>float_res</span>

    <span class=n>best_result</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> \
        <span class=n>int_res_2</span> <span class=k>if</span> <span class=n>int_frac_2</span> <span class=o><=</span> <span class=n>int_frac_1</span> <span class=k>else</span> <span class=n>int_res_1</span>
    <span class=k>return</span> <span class=o>-</span><span class=n>best_result</span> <span class=k>if</span> <span class=n>minus</span> <span class=k>else</span> <span class=n>best_result</span>  <span class=c1># fix sign of result</span></div>



<div class=viewcode-block id=try_float_int_div>
<a class=viewcode-back href=../../../pycommons.math.html#pycommons.math.int_math.try_float_int_div>[docs]</a>
<span class=k>def</span><span class=w> </span><span class=nf>try_float_int_div</span><span class=p>(</span><span class=n>a</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>,</span> <span class=n>b</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-></span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Try to divide a float by an int at best precision.</span>

<span class=sd>    :param a: the first number, which is either a float or an int</span>
<span class=sd>    :param b: the second number, which must be an int</span>
<span class=sd>    :returns: `a/b`, but always finite</span>

<span class=sd>    :raises ValueError: if either one of the arguments or the final result</span>
<span class=sd>        would not be finite</span>
<span class=sd>    :raises TypeError: if either one of `a` or `b` is neither an integer nor</span>
<span class=sd>        a float</span>

<span class=sd>    >>> try_float_int_div(10, 2)</span>
<span class=sd>    5</span>

<span class=sd>    >>> try_float_int_div(10.0, 2)</span>
<span class=sd>    5</span>

<span class=sd>    >>> try_float_int_div(10, 3)</span>
<span class=sd>    3.3333333333333335</span>

<span class=sd>    >>> try_float_int_div(-10, 2)</span>
<span class=sd>    -5</span>

<span class=sd>    >>> try_float_int_div(-10.2, 2)</span>
<span class=sd>    -5.1</span>

<span class=sd>    >>> try_float_int_div(-10.0, 2)</span>
<span class=sd>    -5</span>

<span class=sd>    >>> try_float_int_div(-10, 3)</span>
<span class=sd>    -3.3333333333333335</span>

<span class=sd>    >>> print(type(try_float_int_div(10.0, 2)))</span>
<span class=sd>    &LTclass 'int'></span>

<span class=sd>    >>> print(type(try_float_int_div(10.0, 3)))</span>
<span class=sd>    &LTclass 'float'></span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_float_int_div(10, 0.5)</span>
<span class=sd>    ... except TypeError as te:</span>
<span class=sd>    ...     print(te)</span>
<span class=sd>    b should be an instance of int but is float, namely 0.5.</span>

<span class=sd>    >>> from math import inf, nan</span>
<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_float_int_div(1.0, 0)</span>
<span class=sd>    ... except ZeroDivisionError as zde:</span>
<span class=sd>    ...     print(zde)</span>
<span class=sd>    integer division or modulo by zero</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_float_int_div(inf, 0)</span>
<span class=sd>    ... except ValueError as ve:</span>
<span class=sd>    ...     print(ve)</span>
<span class=sd>    Value must be finite, but is inf.</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_float_int_div(-inf, 0)</span>
<span class=sd>    ... except ValueError as ve:</span>
<span class=sd>    ...     print(ve)</span>
<span class=sd>    Value must be finite, but is -inf.</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_float_int_div(nan, 0)</span>
<span class=sd>    ... except ValueError as ve:</span>
<span class=sd>    ...     print(ve)</span>
<span class=sd>    Value must be finite, but is nan.</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_float_int_div(1, inf)</span>
<span class=sd>    ... except TypeError as te:</span>
<span class=sd>    ...     print(te)</span>
<span class=sd>    b should be an instance of int but is float, namely inf.</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_float_int_div("y", 1)</span>
<span class=sd>    ... except TypeError as te:</span>
<span class=sd>    ...     print(te)</span>
<span class=sd>    value should be an instance of any in {float, int} but is str, namely 'y'.</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_float_int_div(1, "x")</span>
<span class=sd>    ... except TypeError as te:</span>
<span class=sd>    ...     print(te)</span>
<span class=sd>    b should be an instance of int but is str, namely 'x'.</span>
<span class=sd>    """</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=s2>"b"</span><span class=p>,</span> <span class=nb>int</span><span class=p>)</span>
    <span class=n>a</span> <span class=o>=</span> <span class=n>try_int</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>try_int_div</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>__try_int</span><span class=p>(</span><span class=n>a</span> <span class=o>/</span> <span class=n>b</span><span class=p>)</span></div>



<span class=c1>#: the maximum value of a root that can be computed with floats exactly</span>
<span class=n>__MAX_I_ROOT</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>__DBL_INT_LIMIT_P_I</span> <span class=o>*</span> <span class=n>__DBL_INT_LIMIT_P_I</span>


<div class=viewcode-block id=try_int_sqrt>
<a class=viewcode-back href=../../../pycommons.math.html#pycommons.math.int_math.try_int_sqrt>[docs]</a>
<span class=k>def</span><span class=w> </span><span class=nf>try_int_sqrt</span><span class=p>(</span><span class=n>value</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-></span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Try to compute the square root of a potentially large integer.</span>

<span class=sd>    :param value: the value</span>
<span class=sd>    :returns: the square root</span>
<span class=sd>    :raises ValueError: if `value` is negative</span>
<span class=sd>    :raises TypeError: if `value` is not an integer</span>

<span class=sd>    >>> try_int_sqrt(0)</span>
<span class=sd>    0</span>

<span class=sd>    >>> try_int_sqrt(1)</span>
<span class=sd>    1</span>

<span class=sd>    >>> try_int_sqrt(2)</span>
<span class=sd>    1.4142135623730951</span>

<span class=sd>    >>> try_int_sqrt(3)</span>
<span class=sd>    1.7320508075688772</span>

<span class=sd>    >>> try_int_sqrt(4)</span>
<span class=sd>    2</span>

<span class=sd>    >>> try_int_sqrt(5)</span>
<span class=sd>    2.23606797749979</span>

<span class=sd>    >>> try_int_sqrt(6)</span>
<span class=sd>    2.449489742783178</span>

<span class=sd>    >>> try_int_sqrt(7)</span>
<span class=sd>    2.6457513110645907</span>

<span class=sd>    >>> try_int_sqrt(8)</span>
<span class=sd>    2.8284271247461903</span>

<span class=sd>    >>> try_int_sqrt(9)</span>
<span class=sd>    3</span>

<span class=sd>    # exact result: 67108864.0000000074505805969238277</span>
<span class=sd>    >>> try_int_sqrt(4503599627370497)</span>
<span class=sd>    67108864</span>
<span class=sd>    >>> 67108864 * 67108864</span>
<span class=sd>    4503599627370496</span>
<span class=sd>    >>> sqrt(4503599627370497)</span>
<span class=sd>    67108864.0</span>
<span class=sd>    >>> sqrt(4503599627370497) * sqrt(4503599627370497)</span>
<span class=sd>    4503599627370496.0</span>

<span class=sd>    # exact result: 1592262918131443.14115595358963</span>
<span class=sd>    >>> try_int_sqrt(2535301200456458802993406410753)</span>
<span class=sd>    1592262918131443.2</span>
<span class=sd>    >>> sqrt(2535301200456458802993406410753)</span>
<span class=sd>    1592262918131443.2</span>

<span class=sd>    # exact result: 6369051672525772.564623814</span>
<span class=sd>    >>> try_int_sqrt(40564819207303340847894502572033)</span>
<span class=sd>    6369051672525773</span>
<span class=sd>    >>> sqrt(40564819207303340847894502572033)</span>
<span class=sd>    6369051672525773.0</span>

<span class=sd>    # exact result: 50952413380206180.51699051486817387</span>
<span class=sd>    >>> try_int_sqrt(2596148429267413814265248164610049)</span>
<span class=sd>    50952413380206181</span>
<span class=sd>    >>> sqrt(2596148429267413814265248164610049)</span>
<span class=sd>    5.0952413380206184e+16</span>

<span class=sd>    # exact result: 47695509376267.99690952215843525</span>
<span class=sd>    >>> try_int_sqrt(2274861614661668407597778085)</span>
<span class=sd>    47695509376267.99</span>
<span class=sd>    >>> sqrt(2274861614661668407597778085)</span>
<span class=sd>    47695509376267.99</span>

<span class=sd>    # exact result: 9067560306493833.1123015448971368313360</span>
<span class=sd>    >>> try_int_sqrt(82220649911902536690031728766315)</span>
<span class=sd>    9067560306493833</span>
<span class=sd>    >>> sqrt(82220649911902536690031728766315)</span>
<span class=sd>    9067560306493832.0</span>

<span class=sd>    >>> try_int_sqrt(1156)</span>
<span class=sd>    34</span>
<span class=sd>    >>> 34 * 34</span>
<span class=sd>    1156</span>
<span class=sd>    >>> sqrt(1156)</span>
<span class=sd>    34.0</span>
<span class=sd>    >>> 34.0 * 34.0</span>
<span class=sd>    1156.0</span>

<span class=sd>    >>> try_int_sqrt(1005)</span>
<span class=sd>    31.701734968294716</span>
<span class=sd>    >>> 31.701734968294716 * 31.701734968294716</span>
<span class=sd>    1005.0</span>
<span class=sd>    >>> sqrt(1005)</span>
<span class=sd>    31.701734968294716</span>
<span class=sd>    >>> 31.701734968294716 * 31.701734968294716</span>
<span class=sd>    1005.0</span>

<span class=sd>    exact result: 1098367625620897554397104127853022914763109648022\</span>
<span class=sd>928865503114153469686909343624968339609542505832728796367409822636937\</span>
<span class=sd>28593951807995466301001184452657840914432</span>
<span class=sd>    >>> try_int_sqrt(int("1206411441012088169768424908631547135410050\</span>
<span class=sd>450349701156359323012992324468898745458674194715627653148741645085002\</span>
<span class=sd>880167432962708099995812635821183919553390204438671018341579206970136\</span>
<span class=sd>807811815836079357669821219116858017489215282754293788095448310134150\</span>
<span class=sd>6291035205862448784848059094859987648259778470316291228729945882624"))</span>
<span class=sd>    10983676256208975543971041278530229147631096480229288655031141534\</span>
<span class=sd>696869093436249683396095425058327287963674098226369372859395180799546\</span>
<span class=sd>6301001184452657840914432</span>

<span class=sd>    # exact result: 112519976.73369080909552361</span>
<span class=sd>    >>> try_int_sqrt(12660745164150321)</span>
<span class=sd>    112519976.73369081</span>
<span class=sd>    >>> 112519976.73369081 * 112519976.73369081</span>
<span class=sd>    1.2660745164150322e+16</span>
<span class=sd>    >>> sqrt(12660745164150321)</span>
<span class=sd>    112519976.7336908</span>
<span class=sd>    >>> 112519976.7336908 * 112519976.7336908</span>
<span class=sd>    1.2660745164150318e+16</span>

<span class=sd>    >>> try_int_sqrt(12369445361672285)</span>
<span class=sd>    111218008.26157734</span>
<span class=sd>    >>> sqrt(12369445361672285)</span>
<span class=sd>    111218008.26157734</span>

<span class=sd>    # exact result: 94906265.624251558157461955425</span>
<span class=sd>    >>> try_int_sqrt(9007199254740993)</span>
<span class=sd>    94906265.62425156</span>
<span class=sd>    >>> 94906265.62425156 * 94906265.62425156</span>
<span class=sd>    9007199254740994.0</span>
<span class=sd>    >>> sqrt(9007199254740993)</span>
<span class=sd>    94906265.62425156</span>
<span class=sd>    >>> 94906265.62425156 * 94906265.62425156</span>
<span class=sd>    9007199254740994.0</span>

<span class=sd>    # exact result: 126969687.206733737782866</span>
<span class=sd>    >>> try_int_sqrt(16121301469375805)</span>
<span class=sd>    126969687.20673373</span>
<span class=sd>    >>> 126969687.20673373 * 126969687.20673373</span>
<span class=sd>    1.6121301469375804e+16</span>
<span class=sd>    >>> sqrt(16121301469375805)</span>
<span class=sd>    126969687.20673373</span>
<span class=sd>    >>> 126969687.20673373 * 126969687.20673373</span>
<span class=sd>    1.6121301469375804e+16</span>

<span class=sd>    # exact result: 94906265.6242515686941740831</span>
<span class=sd>    # here we are off a bit!</span>
<span class=sd>    >>> try_int_sqrt(9007199254740995)</span>
<span class=sd>    94906265.62425156</span>
<span class=sd>    >>> 94906265.62425156 * 94906265.62425156</span>
<span class=sd>    9007199254740994.0</span>
<span class=sd>    >>> sqrt(9007199254740995)</span>
<span class=sd>    94906265.62425157</span>
<span class=sd>    >>> 94906265.62425157 * 94906265.62425157</span>
<span class=sd>    9007199254740996.0</span>

<span class=sd>    # exact result: 102406758.28296330267545316</span>
<span class=sd>    >>> try_int_sqrt(10487144142025273)</span>
<span class=sd>    102406758.2829633</span>
<span class=sd>    >>> 102406758.2829633 * 102406758.2829633</span>
<span class=sd>    1.0487144142025274e+16</span>
<span class=sd>    >>> sqrt(10487144142025273)</span>
<span class=sd>    102406758.28296329</span>
<span class=sd>    >>> 102406758.28296329 * 102406758.28296329</span>
<span class=sd>    1.048714414202527e+16</span>

<span class=sd>    # exact result: 101168874.5492688823358</span>
<span class=sd>    >>> try_int_sqrt(10235141177565705)</span>
<span class=sd>    101168874.54926889</span>
<span class=sd>    >>> 101168874.54926889 * 101168874.54926889</span>
<span class=sd>    1.0235141177565706e+16</span>
<span class=sd>    >>> sqrt(10235141177565705)</span>
<span class=sd>    101168874.54926887</span>
<span class=sd>    >>> 101168874.54926887 * 101168874.54926887</span>
<span class=sd>    1.0235141177565702e+16</span>

<span class=sd>    # exact result: 123961449.976073299398431984</span>
<span class=sd>    >>> try_int_sqrt(15366441080170523)</span>
<span class=sd>    123961449.9760733</span>
<span class=sd>    >>> 123961449.9760733 * 123961449.9760733</span>
<span class=sd>    1.5366441080170522e+16</span>
<span class=sd>    >>> sqrt(15366441080170523)</span>
<span class=sd>    123961449.97607331</span>
<span class=sd>    >>> 123961449.97607331 * 123961449.97607331</span>
<span class=sd>    1.5366441080170526e+16</span>

<span class=sd>    # exact result: 4760418939079673.01527272985</span>
<span class=sd>    >>> try_int_sqrt(22661588475548439582669426672241)</span>
<span class=sd>    4760418939079673</span>
<span class=sd>    >>> 4760418939079673 * 4760418939079673</span>
<span class=sd>    22661588475548439437260241786929</span>
<span class=sd>    >>> sqrt(22661588475548439582669426672241)</span>
<span class=sd>    4760418939079673.0</span>
<span class=sd>    >>> 4760418939079673.0 * 4760418939079673.0</span>
<span class=sd>    2.266158847554844e+31</span>

<span class=sd>    # exact result: 5712179292532910.79362200453777547</span>
<span class=sd>    >>> try_int_sqrt(32628992270041785263905793906381)</span>
<span class=sd>    5712179292532911</span>
<span class=sd>    >>> 5712179292532911 * 5712179292532911</span>
<span class=sd>    32628992270041787621642018133921</span>
<span class=sd>    >>> sqrt(32628992270041785263905793906381)</span>
<span class=sd>    5712179292532911.0</span>
<span class=sd>    >>> 5712179292532911.0 * 5712179292532911.0</span>
<span class=sd>    3.2628992270041787e+31</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_int_sqrt(-1)</span>
<span class=sd>    ... except ValueError as ve:</span>
<span class=sd>    ...     print(ve)</span>
<span class=sd>    Compute the root of -1 ... really?</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_int_sqrt(1.0)</span>
<span class=sd>    ... except TypeError as te:</span>
<span class=sd>    ...     print(te)</span>
<span class=sd>    value should be an instance of int but is float, namely 1.0.</span>
<span class=sd>    """</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=s2>"value"</span><span class=p>,</span> <span class=nb>int</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>value</span> <span class=o><</span> <span class=mi>0</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"Compute the root of </span><span class=si>{</span><span class=n>value</span><span class=si>}</span><span class=s2> ... really?"</span><span class=p>)</span>

    <span class=c1># First, let's compute the integer root. This is basically the</span>
    <span class=c1># rounded-down version of the actual root. The integer root (isqrt) is the</span>
    <span class=c1># lower limit for the result.</span>
    <span class=c1># In the odd chance that this is already the correct result, we can</span>
    <span class=c1># directly stop and return it.</span>
    <span class=n>result_low</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>isqrt</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
    <span class=n>diff_low</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span> <span class=o>-</span> <span class=p>(</span><span class=n>result_low</span> <span class=o>*</span> <span class=n>result_low</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>diff_low</span> <span class=o><=</span> <span class=mi>0</span><span class=p>:</span>
        <span class=c1># Notice: If we get here, then seemingly `isqrt(value) == sqrt(value)`</span>
        <span class=c1># in Python's implementation if `value` the result fits into the</span>
        <span class=c1># float range (I think).</span>
        <span class=k>return</span> <span class=n>result_low</span>

    <span class=c1># First, we use the floating point sqrt for all numbers that can exactly</span>
    <span class=c1># be represented as floating point numbers. Of course we try to convert</span>
    <span class=c1># the result to integers.</span>
    <span class=k>if</span> <span class=n>value</span> <span class=o><=</span> <span class=n>__DBL_INT_LIMIT_P_I</span><span class=p>:</span>  <span class=c1># default to the normal Python sqrt.</span>
        <span class=k>return</span> <span class=n>__try_int</span><span class=p>(</span><span class=n>sqrt</span><span class=p>(</span><span class=n>value</span><span class=p>))</span>  <span class=c1># we can compute the exact square root</span>

    <span class=c1># `value` is bigger than 2 ** 53 and definitely does not fit into a float</span>
    <span class=c1># without losing precision.</span>
    <span class=c1># We cannot accurately compute the root of value, because transforming</span>
    <span class=c1># value to an int will already lead to a loss of precision.</span>
    <span class=c1># However, what if sqrt(value) < 2 ** 53?</span>
    <span class=c1># In this case, we *could* represent some fractional digits in the</span>
    <span class=c1># result. But we cannot get them using `sqrt`. So we do a trick:</span>
    <span class=c1># `root(a) = root(a * mul * mul) / mul`.</span>
    <span class=c1># We compute the integer square root of `value` times some value `mul`.</span>
    <span class=c1># We pick `mul` just large enough so that the result of</span>
    <span class=c1># `isqrt(mul * mul * value)` will still be `<= __DBL_INT_LIMIT_P_I` and</span>
    <span class=c1># thus fits into a `float` nicely. We then get the approximate fractional</span>
    <span class=c1># part by dividing by `mul`.</span>
    <span class=k>if</span> <span class=n>result_low</span> <span class=o><</span> <span class=n>__DBL_INT_LIMIT_P_I</span><span class=p>:</span>
        <span class=n>mul</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>__DBL_INT_LIMIT_P_I</span> <span class=o>//</span> <span class=n>result_low</span>
        <span class=k>if</span> <span class=n>mul</span> <span class=o>></span> <span class=mi>1</span><span class=p>:</span>
            <span class=c1># We can proceed like before, just do the integer root at a higher</span>
            <span class=c1># resolution. In this high resolution, we compute both the upper</span>
            <span class=c1># and the lower bound for the root. We then pick the one closer to</span>
            <span class=c1># the actual value, rounding up on draw situations. This value is</span>
            <span class=c1># then divided by the multiplier to give us the maximum precision.</span>
            <span class=n>new_value</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span> <span class=o>*</span> <span class=n>mul</span> <span class=o>*</span> <span class=n>mul</span>
            <span class=n>new_low</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>isqrt</span><span class=p>(</span><span class=n>new_value</span><span class=p>)</span>
            <span class=n>new_diff_low</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_value</span> <span class=o>-</span> <span class=p>(</span><span class=n>new_low</span> <span class=o>*</span> <span class=n>new_low</span><span class=p>)</span>
            <span class=n>new_high</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_low</span> <span class=o>+</span> <span class=mi>1</span>
            <span class=n>new_diff_high</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>new_high</span> <span class=o>*</span> <span class=n>new_high</span><span class=p>)</span> <span class=o>-</span> <span class=n>new_value</span>
            <span class=k>return</span> <span class=n>try_int_div</span><span class=p>(</span>
                <span class=n>new_high</span> <span class=k>if</span> <span class=n>new_diff_high</span> <span class=o><=</span> <span class=n>new_diff_low</span> <span class=k>else</span> <span class=n>new_low</span><span class=p>,</span> <span class=n>mul</span><span class=p>)</span>

    <span class=c1>#: If we get here, then there is just no way to get useful fractional</span>
    <span class=c1>#: parts. We then just check if we should round up the result or return</span>
    <span class=c1>#: the rounded-down result.</span>
    <span class=n>result_up</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>result_low</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
    <span class=n>diff_up</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=p>(</span><span class=n>result_up</span> <span class=o>*</span> <span class=n>result_up</span><span class=p>)</span> <span class=o>-</span> <span class=n>value</span>
    <span class=k>return</span> <span class=n>result_up</span> <span class=k>if</span> <span class=n>diff_up</span> <span class=o><=</span> <span class=n>diff_low</span> <span class=k>else</span> <span class=n>result_low</span></div>



<div class=viewcode-block id=try_int_add>
<a class=viewcode-back href=../../../pycommons.math.html#pycommons.math.int_math.try_int_add>[docs]</a>
<span class=k>def</span><span class=w> </span><span class=nf>try_int_add</span><span class=p>(</span><span class=n>a</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>b</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>)</span> <span class=o>-></span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Try to add a floating point number to an integer.</span>

<span class=sd>    :param a: the integer</span>
<span class=sd>    :param b: the floating point number</span>
<span class=sd>    :returns: `a + b` or the best possible approximation thereof</span>
<span class=sd>    :raises TypeError: if `a` is not an integer or if `b` is neither a</span>
<span class=sd>        float nor an integer</span>
<span class=sd>    :raises ValueError: if `b` or the result is not finite</span>

<span class=sd>    >>> try_int_add(5, 7)</span>
<span class=sd>    12</span>

<span class=sd>    >>> try_int_add(5, 7.0)</span>
<span class=sd>    12</span>

<span class=sd>    >>> try_int_add(0, -8670.320148166094)</span>
<span class=sd>    -8670.320148166094</span>
<span class=sd>    >>> 0 + -8670.320148166094</span>
<span class=sd>    -8670.320148166094</span>

<span class=sd>    >>> try_int_add(-63710, 100.96227261264141)</span>
<span class=sd>    -63609.03772738736</span>
<span class=sd>    >>> -63710 + 100.96227261264141</span>
<span class=sd>    -63609.03772738736</span>

<span class=sd>    >>> try_int_add(77, 12975.955050422272)</span>
<span class=sd>    13052.955050422272</span>
<span class=sd>    >>> 77 + 12975.955050422272</span>
<span class=sd>    13052.955050422272</span>

<span class=sd>    >>> try_int_add(-308129344193738, 62995516.01169562)</span>
<span class=sd>    -308129281198222</span>
<span class=sd>    >>> -308129344193738 + 62995516.01169562</span>
<span class=sd>    -308129281198222.0</span>

<span class=sd>    >>> try_int_add(-2158504468760619, -1.3773316665252534e+16)</span>
<span class=sd>    -1.5931821134013152e+16</span>
<span class=sd>    >>> -2158504468760619 + -1.3773316665252534e+16</span>
<span class=sd>    -1.5931821134013152e+16</span>

<span class=sd>    >>> try_int_add(-960433622582960, 1.491132239895968e+16)</span>
<span class=sd>    1.395088877637672e+16</span>
<span class=sd>    >>> -960433622582960 + 1.491132239895968e+16</span>
<span class=sd>    1.395088877637672e+16</span>

<span class=sd>    # exact result: 10796862382206072.70684135</span>
<span class=sd>    >>> try_int_add(10796862236149287, 146056785.70684135)</span>
<span class=sd>    10796862382206073</span>
<span class=sd>    >>> 10796862236149287 + 146056785.70684135</span>
<span class=sd>    1.0796862382206074e+16</span>

<span class=sd>    # exact result: -11909678744561796.5206623</span>
<span class=sd>    >>> try_int_add(-11909677351933537, -1392628259.5206623)</span>
<span class=sd>    -11909678744561797</span>
<span class=sd>    >>> -11909677351933537 + -1392628259.5206623</span>
<span class=sd>    -1.1909678744561796e+16</span>

<span class=sd>    # exact result: 8991519996993845.25</span>
<span class=sd>    >>> try_int_add(9257476766666634, -265956769672788.75)</span>
<span class=sd>    8991519996993845</span>
<span class=sd>    >>> 9257476766666634 + -265956769672788.75</span>
<span class=sd>    8991519996993845.0</span>

<span class=sd>    >>> v = int("-9166650131241408540833319855375552663116961087945581\</span>
<span class=sd>6489173691561634548053405237489064")</span>
<span class=sd>    >>> try_int_add(v, 6.147962494740932e+217)</span>
<span class=sd>    6.147962494740932e+217</span>
<span class=sd>    >>> v + 6.147962494740932e+217</span>
<span class=sd>    6.147962494740932e+217</span>

<span class=sd>    exact result: 2060196266381720280000783609573994641953401509142\</span>
<span class=sd>0431778715465940577471030.192914550695235</span>
<span class=sd>    >>> v = int("2060196266381720280000783609573994641953401509142043\</span>
<span class=sd>1778715465940577470980")</span>
<span class=sd>    >>> try_int_add(v, 50.192914550695235)</span>
<span class=sd>    20601962663817202800007836095739946419534015091420431778715465940\</span>
<span class=sd>577471030</span>
<span class=sd>    >>> v + 50.192914550695235</span>
<span class=sd>    2.0601962663817203e+73</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_int_add(2.0, 1)</span>
<span class=sd>    ... except TypeError as te:</span>
<span class=sd>    ...     print(te)</span>
<span class=sd>    a should be an instance of int but is float, namely 2.0.</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_int_add(2, "1")</span>
<span class=sd>    ... except TypeError as te:</span>
<span class=sd>    ...     print(te)</span>
<span class=sd>    b should be an instance of any in {float, int} but is str, namely '1'.</span>

<span class=sd>    >>> from math import inf</span>
<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_int_add(2, inf)</span>
<span class=sd>    ... except ValueError as ve:</span>
<span class=sd>    ...     print(ve)</span>
<span class=sd>    b=inf is not finite</span>
<span class=sd>    """</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=s2>"a"</span><span class=p>,</span> <span class=nb>int</span><span class=p>)</span>
    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=nb>float</span><span class=p>):</span>
        <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=s2>"b"</span><span class=p>,</span> <span class=p>(</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>))</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=n>isfinite</span><span class=p>(</span><span class=n>b</span><span class=p>):</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>b</span><span class=si>=}</span><span class=s2> is not finite"</span><span class=p>)</span>

    <span class=c1># First we attempt to turn b into an integer, because that would solve all</span>
    <span class=c1># of our problems.</span>
    <span class=n>b</span> <span class=o>=</span> <span class=n>__try_int</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>
    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span>  <span class=c1># We are lucky, the result is an integer</span>

    <span class=n>b_num</span><span class=p>,</span> <span class=n>b_denom</span> <span class=o>=</span> <span class=n>float_to_frac</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>
    <span class=n>int_num</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>b_num</span> <span class=o>//</span> <span class=n>b_denom</span>
    <span class=n>int_res</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>a</span> <span class=o>+</span> <span class=n>int_num</span>

    <span class=n>a_exact</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=n>__DBL_INT_LIMIT_N_I</span> <span class=o><</span> <span class=n>a</span> <span class=o><</span> <span class=n>__DBL_INT_LIMIT_P_I</span>
    <span class=n>b_exact</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=n>__DBL_INT_LIMIT_N_I</span> <span class=o><</span> <span class=n>b</span> <span class=o><</span> <span class=n>__DBL_INT_LIMIT_P_I</span>
    <span class=n>res_exact</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> \
        <span class=n>__DBL_INT_LIMIT_N_I</span> <span class=o><</span> <span class=n>int_res</span> <span class=o><</span> <span class=n>__DBL_INT_LIMIT_P_I</span>
    <span class=k>if</span> <span class=n>a_exact</span> <span class=ow>and</span> <span class=n>b_exact</span> <span class=ow>and</span> <span class=n>res_exact</span><span class=p>:</span>
        <span class=c1># We know that the result should fit well into the float range.</span>
        <span class=c1># So we can just compute it normally</span>
        <span class=k>return</span> <span class=n>__try_int</span><span class=p>(</span><span class=n>a</span> <span class=o>+</span> <span class=n>b</span><span class=p>)</span>

    <span class=k>if</span> <span class=ow>not</span> <span class=n>b_exact</span><span class=p>:</span>
        <span class=c1># Now if we get here, we are in a strange territory.</span>
        <span class=c1># The floating point character of `b` will definitely pollute the</span>
        <span class=c1># result. Regardless of what we do, we will not just have a rounding</span>
        <span class=c1># error that costs us a fractional part, but it will cost decimals.</span>
        <span class=c1># The right thing to do may be to return a float here, because we do</span>
        <span class=c1># know that floats have a limited resolution and the returned value</span>
        <span class=c1># may be biased.</span>
        <span class=n>float_res</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>float</span><span class=p>]</span> <span class=o>=</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span>
        <span class=k>if</span> <span class=n>isfinite</span><span class=p>(</span><span class=n>float_res</span><span class=p>):</span>
            <span class=k>return</span> <span class=n>__try_int</span><span class=p>(</span><span class=n>float_res</span><span class=p>)</span>

    <span class=c1># If we get here, then b is either an exactly representable float or the</span>
    <span class=c1># result of adding a to b would no longer be finite.</span>
    <span class=c1># If `b` is an exactly represented float, this means that the result does</span>
    <span class=c1># not fit into a float. So we just try to round the result.</span>
    <span class=c1># We will lose a fractional part, but the integer part will be exact.</span>
    <span class=c1># `a` is an integer, so it is exact anyway. The integer part of `b`</span>
    <span class=c1># can be represented as exact integer as well. So this means that we</span>
    <span class=c1># will lose the fractional part only.</span>
    <span class=c1># We can do the same thing if the result of the computation would not be</span>
    <span class=c1># finite. Although it would be a bit pretentious to round in such a</span>
    <span class=c1># situation ... well ... why not.</span>
    <span class=n>b_num</span> <span class=o>-=</span> <span class=n>int_num</span> <span class=o>*</span> <span class=n>b_denom</span>
    <span class=n>round_up</span><span class=p>:</span> <span class=n>Final</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>b_num</span> <span class=o>+</span> <span class=n>b_num</span><span class=p>)</span> <span class=o>>=</span> <span class=n>b_denom</span>
    <span class=k>return</span> <span class=p>(</span><span class=n>int_res</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=k>if</span> <span class=p>(</span><span class=n>round_up</span> <span class=ow>and</span> <span class=p>(</span><span class=n>b_num</span> <span class=o><</span> <span class=mi>0</span><span class=p>))</span> <span class=k>else</span> <span class=p>(</span>
        <span class=p>(</span><span class=n>int_res</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=k>if</span> <span class=n>round_up</span> <span class=ow>and</span> <span class=p>(</span><span class=n>b_num</span> <span class=o>></span> <span class=mi>0</span><span class=p>)</span> <span class=k>else</span> <span class=n>int_res</span><span class=p>)</span></div>



<div class=viewcode-block id=try_int_mul>
<a class=viewcode-back href=../../../pycommons.math.html#pycommons.math.int_math.try_int_mul>[docs]</a>
<span class=k>def</span><span class=w> </span><span class=nf>try_int_mul</span><span class=p>(</span><span class=n>a</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>b</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>)</span> <span class=o>-></span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span><span class=p>:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Try to multiply an integer with an int or float as exactly as possible.</span>

<span class=sd>    :param a: the integer</span>
<span class=sd>    :param b: the int or float to multiply `a` with</span>
<span class=sd>    :returns: `a * b`</span>
<span class=sd>    :raises ValueError: if `b` or the result is not finite</span>
<span class=sd>    :raises TypeError: if `a` is not an integer or if `b` is neither an</span>
<span class=sd>        integer nor a float</span>

<span class=sd>    >>> try_int_mul(6, 5)</span>
<span class=sd>    30</span>

<span class=sd>    # exact result: -111038109230780524.216538356</span>
<span class=sd>    >>> try_int_mul(197262324754, -562895.673916714)</span>
<span class=sd>    -111038109230780524</span>
<span class=sd>    >>> 197262324754 * -562895.673916714</span>
<span class=sd>    -1.1103810923078053e+17</span>

<span class=sd>    >>> try_int_mul(4, -2493374.0)</span>
<span class=sd>    -9973496</span>
<span class=sd>    >>> 4 * -2493374.0</span>
<span class=sd>    -9973496.0</span>

<span class=sd>    # exact result: -805144077682.7549712841791</span>
<span class=sd>    >>> try_int_mul(609329061, -1321.3616897926931)</span>
<span class=sd>    -805144077682.755</span>
<span class=sd>    >>> 609329061 * -1321.3616897926931</span>
<span class=sd>    -805144077682.755</span>

<span class=sd>    # exact result: -88939650274621002534.99</span>
<span class=sd>    >>> try_int_mul(-6548165, 13582377700412.406)</span>
<span class=sd>    -88939650274621004172</span>
<span class=sd>    >>> -6548165 * 13582377700412.406</span>
<span class=sd>    -8.8939650274621e+19</span>

<span class=sd>    >>> try_int_mul(4, 0.687279486538305)</span>
<span class=sd>    2.74911794615322</span>
<span class=sd>    >>> 4 * 0.687279486538305</span>
<span class=sd>    2.74911794615322</span>

<span class=sd>    # exact result: -2236563847561524626.733</span>
<span class=sd>    >>> try_int_mul(21396228, -104530754091.86725)</span>
<span class=sd>    -2236563847561524627</span>
<span class=sd>    >>> 21396228 * -104530754091.86725</span>
<span class=sd>    -2.2365638475615245e+18</span>

<span class=sd>    # exact result: -92649832027598387270282.5408</span>
<span class=sd>    >>> try_int_mul(29187432758, -3174305626527.0176)</span>
<span class=sd>    -92649832027598386631807</span>
<span class=sd>    >>> 29187432758 * -3174305626527.0176</span>
<span class=sd>    -9.264983202759838e+22</span>

<span class=sd>    # exact result: 47954872443652456553018463.12996</span>
<span class=sd>    >>> try_int_mul(-317420410641789, -151076839534.96564)</span>
<span class=sd>    47954872443652455666473176</span>
<span class=sd>    >>> -317420410641789 * -151076839534.96564</span>
<span class=sd>    4.795487244365246e+25</span>

<span class=sd>    # exact result: 369200712310299349798.80066193866</span>
<span class=sd>    >>> try_int_mul(8136505182920565, 45375.834465796564)</span>
<span class=sd>    369200712310299353646</span>
<span class=sd>    >>> 8136505182920565 * 45375.834465796564</span>
<span class=sd>    3.6920071231029936e+20</span>

<span class=sd>    # exact result: 431520767093145743090.73845486</span>
<span class=sd>    >>> try_int_mul(40196153594795, 10735374.619252708)</span>
<span class=sd>    431520767093145743091</span>
<span class=sd>    >>> 40196153594795 * 10735374.619252708</span>
<span class=sd>    4.315207670931457e+20</span>

<span class=sd>    # exact result: -250242005217172713.52783326</span>
<span class=sd>    >>> try_int_mul(27941562579, -8955905.90217194)</span>
<span class=sd>    -250242005217172703</span>
<span class=sd>    >>> 27941562579 * -8955905.90217194</span>
<span class=sd>    -2.502420052171727e+17</span>

<span class=sd>    # exact result: -6563728914129924.848948421</span>
<span class=sd>    >>> try_int_mul(-672426819, 9761253.906991959)</span>
<span class=sd>    -6563728914129925</span>
<span class=sd>    >>> -672426819 * 9761253.906991959</span>
<span class=sd>    -6563728914129925.0</span>

<span class=sd>    >>> try_int_mul(14059, 1.0673811010650016e+16)</span>
<span class=sd>    1.5006310899872858e+20</span>
<span class=sd>    >>> 14059 * 1.0673811010650016e+16</span>
<span class=sd>    1.5006310899872858e+20</span>

<span class=sd>    # exact result: 14493050353163113.126430160675</span>
<span class=sd>    >>> try_int_mul(240712887635, 60208.867483403505)</span>
<span class=sd>    14493050353163113</span>
<span class=sd>    >>> 240712887635 * 60208.867483403505</span>
<span class=sd>    1.4493050353163114e+16</span>

<span class=sd>    # exact result: 805460953505875910367.5205722154</span>
<span class=sd>    >>> try_int_mul(1812115257906061, 444486.6020479314)</span>
<span class=sd>    805460953505875915662</span>
<span class=sd>    >>> 1812115257906061 * 444486.6020479314</span>
<span class=sd>    8.054609535058759e+20</span>

<span class=sd>    # exact result: -1384354228892504466.5554728510606</span>
<span class=sd>    >>> try_int_mul(6815245310862468, -203.12610416033795)</span>
<span class=sd>    -1384354228892504435</span>
<span class=sd>    >>> 6815245310862468 * -203.12610416033795</span>
<span class=sd>    -1.3843542288925043e+18</span>

<span class=sd>    # exact result: -572028608656496.423924280629596728</span>
<span class=sd>    >>> try_int_mul(11587431214834713, -0.049366300265425656)</span>
<span class=sd>    -572028608656496.4</span>
<span class=sd>    >>> 11587431214834713 * -0.049366300265425656</span>
<span class=sd>    -572028608656496.4</span>

<span class=sd>    # exact result: 1128618866534760.28918431873755142</span>
<span class=sd>    >>> try_int_mul(16354919666787217, 0.06900791257487526)</span>
<span class=sd>    1128618866534760.2</span>
<span class=sd>    >>> 16354919666787217 * 0.06900791257487526</span>
<span class=sd>    1128618866534760.2</span>

<span class=sd>    # exact result: -2507326755278071.50624700782133248</span>
<span class=sd>    >>> try_int_mul(13217245192529664, -0.18970116077556032)</span>
<span class=sd>    -2507326755278071.5</span>
<span class=sd>    >>> 13217245192529664 * -0.18970116077556032</span>
<span class=sd>    -2507326755278071.5</span>

<span class=sd>    # exact result: 696151526057376.88027486041356184</span>
<span class=sd>    >>> try_int_mul(-10333677547666606, -0.06736725844658964)</span>
<span class=sd>    696151526057376.9</span>
<span class=sd>    >>> -10333677547666606 * -0.06736725844658964</span>
<span class=sd>    696151526057376.9</span>

<span class=sd>    # exact result: -958450150333374.5128889837837098</span>
<span class=sd>    >>> try_int_mul(12016909016999122, -0.0797584594322509)</span>
<span class=sd>    -958450150333374.6</span>
<span class=sd>    >>> 12016909016999122 * -0.0797584594322509</span>
<span class=sd>    -958450150333374.6</span>

<span class=sd>    >>> aa = int("1318537368301039863303586092319665276843530233302383387022\</span>
<span class=sd>8761465225501763768872549741384158750496877681759291226540877199284501122993\</span>
<span class=sd>0897105528797412214008383330709731057075605034370259681835287681493225337651\</span>
<span class=sd>3905721656778533145739528500419884652958325779506781860934858448618309985340\</span>
<span class=sd>2653730863759125601710698375950989559971436924737005754922330642277477754688\</span>
<span class=sd>4919382044527420457991975491785609852030831998308070776211565814942350933642\</span>
<span class=sd>672902063132158594646597242361650005228312919254855")</span>
<span class=sd>    >>> try_int_mul(aa, -2.6624992899981142e+135)</span>
<span class=sd>    -351060480693750064453835292428076534998065626248205859394224131928297807\</span>
<span class=sd>37557248636560809666436142921728329271829636053027677161961750893317035607449\</span>
<span class=sd>88120284425121093171262696954695038088240282639132134536157970777415620680544\</span>
<span class=sd>77787260819949647198753734696904695444416894546646340086090596255528370630342\</span>
<span class=sd>39912680252313956743223994856279867123453950294756395973723697089090287742438\</span>
<span class=sd>42755397630769057958666859505455598999506335122025009809406354300546655548757\</span>
<span class=sd>03308334026066509069233835834019214049819194441000000000000000000000000000000\</span>
<span class=sd>00000000000000000000000000000000000000000000000000000000000000000000000000000\</span>
<span class=sd>0000000000000</span>

<span class=sd>    # exact result: 5115993211447460900.43715653698</span>
<span class=sd>    >>> try_int_mul(45247701671134, 113066.36630145647)</span>
<span class=sd>    5115993211447460734</span>
<span class=sd>    >>> 45247701671134 * 113066.36630145647</span>
<span class=sd>    5.115993211447461e+18</span>

<span class=sd>    # exact result: -125197981872321984234</span>
<span class=sd>    >>> try_int_mul(-15606149727, 8022349142.0)</span>
<span class=sd>    -125197981872321984234</span>
<span class=sd>    >>> -15606149727 * 8022349142.0</span>
<span class=sd>    -1.2519798187232199e+20</span>

<span class=sd>    # exact result: -348481045.61578014504</span>
<span class=sd>    >>> try_int_mul(6636, -52513.71995415614)</span>
<span class=sd>    -348481045.6157802</span>
<span class=sd>    >>> 6636 * -52513.71995415614</span>
<span class=sd>    -348481045.6157802</span>

<span class=sd>    # exact result: -339789407482572717.3787168852228</span>
<span class=sd>    >>> try_int_mul(6921658507965838, -49.0907500119406)</span>
<span class=sd>    -339789407482572714</span>
<span class=sd>    >>> 6921658507965838 * -49.0907500119406</span>
<span class=sd>    -3.3978940748257274e+17</span>

<span class=sd>    >>> try_int_mul(2366231432701, 9061910680864392.0)</span>
<span class=sd>    2.1442577893390244e+28</span>
<span class=sd>    >>> 2366231432701 * 9061910680864392.0</span>
<span class=sd>    2.1442577893390244e+28</span>

<span class=sd>    >>> try_int_mul(11382697409900285, 7338977711.446167)</span>
<span class=sd>    8.35373625873942e+25</span>
<span class=sd>    >>> 11382697409900285 * 7338977711.446167</span>
<span class=sd>    8.35373625873942e+25</span>

<span class=sd>    >>> try_int_mul(34207518885, -6554.28955920917)</span>
<span class=sd>    -224205983874406</span>
<span class=sd>    >>> 34207518885 * -6554.28955920917</span>
<span class=sd>    -224205983874406.0</span>

<span class=sd>    >>> try_int_mul(35107, -165228482913.08173)</span>
<span class=sd>    -5800676349629560</span>
<span class=sd>    >>> 35107 * -165228482913.08173</span>
<span class=sd>    -5800676349629560.0</span>

<span class=sd>    >>> try_int_mul(0, 2.4281702332336544e+16)</span>
<span class=sd>    0</span>
<span class=sd>    >>> 0 * 2.4281702332336544e+16</span>
<span class=sd>    0.0</span>

<span class=sd>    >>> try_int_mul(12299117359251193, 9482167930204820.0)</span>
<span class=sd>    1.1662229619371705e+32</span>
<span class=sd>    >>> 12299117359251193 * 9482167930204820.0</span>
<span class=sd>    1.1662229619371705e+32</span>

<span class=sd>    >>> try_int_mul(-11025104822925196, 0.20926918490209712)</span>
<span class=sd>    -2307214699753735.5</span>
<span class=sd>    >>> -11025104822925196 * 0.20926918490209712</span>
<span class=sd>    -2307214699753735.5</span>

<span class=sd>    >>> try_int_mul(9772540954912922, -0.46316069211643107)</span>
<span class=sd>    -4526256832413637</span>
<span class=sd>    >>> 9772540954912922 * -0.46316069211643107</span>
<span class=sd>    -4526256832413637.0</span>

<span class=sd>    >>> a = -5687274133508874816611305835797802819969961090128107452007652532\</span>
<span class=sd>73368270677846755602944621609056451583453036433989268229052391280449456056415\</span>
<span class=sd>35305434613932448168719851117464179317780697744165312772461358166814824851088\</span>
<span class=sd>55666554914988361150741132171265507858468795070096289596042533878836544303330\</span>
<span class=sd>51629205606376256678385083639086123757879299418359388159156263956657201968562\</span>
<span class=sd>31234444965574888174813926197455099511160764637390234826490840919289969902451\</span>
<span class=sd>19032766058028744</span>
<span class=sd>    >>> try_int_mul(a, 1.6152587208080178e+161)</span>
<span class=sd>    -918641914177607297827455991165295995836557166831605550508325736176299541\</span>
<span class=sd>25010211147428340193055785106681257889474710879610768609064675870154966345681\</span>
<span class=sd>26449034000026631687248880284694987083010601085095100350470698767695524042980\</span>
<span class=sd>42911001628323193080493646299015542596054871017084303004624332857182391257042\</span>
<span class=sd>52801685333053155075946721706578407082236529399950593562831974178899888856652\</span>
<span class=sd>93388328544269797554613495534930019750820141133495887308100045109322649359377\</span>
<span class=sd>82349254851477073806364320000000000000000000000000000000000000000000000000000\</span>
<span class=sd>00000000000000000000000000000000000000000000000000000000000000000000000000000\</span>
<span class=sd>0000000000000000</span>

<span class=sd>    >>> a = 3765608478313035700785399638168771339557519363527174997097642640\</span>
<span class=sd>6101495713891805694367423527904175961734525627539554843115375392781571623329\</span>
<span class=sd>2447297269149929791925360073769054144096521088071580437368293552550840688369\</span>
<span class=sd>2608265449974834262318405099511472680054858496169995743896513251354009716226\</span>
<span class=sd>2514585220536136586004979988630733951340879593101821106230203914627052267837\</span>
<span class=sd>1572821101974821796182780210158355368107881592427373376547394885537235348770\</span>
<span class=sd>037983728077456443610490231815763426207048140659081123096064113083255321</span>
<span class=sd>    >>> try_int_mul(a, 3.4397561272117625e+192)</span>
<span class=sd>    1295277483595782584113508134012218246618268914040678972148674688561811055\</span>
<span class=sd>62545645638406847972665826258090260136864511189660481257690662245650013258245\</span>
<span class=sd>87407098713534544479908700377722686202681649709236855552895540002411099678400\</span>
<span class=sd>34930596196955500638683411789710844172886586592715303399853135479663325522628\</span>
<span class=sd>18566899383275992198837024474126244312079099847486179805861514713317955269085\</span>
<span class=sd>29746017598066404007065119460848331815196502119813180662866870212988690952959\</span>
<span class=sd>01261701816146501989018193091814958202143246046408892578628261894621913262500\</span>
<span class=sd>00000000000000000000000000000000000000000000000000000000000000000000000000000\</span>
<span class=sd>00000000000000000000000000000000000000000000000000000000000000000000000000000\</span>
<span class=sd>00000000000000000000</span>

<span class=sd>    >>> a = 129139500057625933922412781529753661193714022177289159193286727\</span>
<span class=sd>341869510538391068183373334814894358463049932698275602586001788553855337370\</span>
<span class=sd>614701810798567624656761308982494637834371899037091828942757328272879402878\</span>
<span class=sd>026516716840890321410558877108818475215456025987413249018189775618174448780\</span>
<span class=sd>086119164868545066265500186250891155310591180702358002</span>
<span class=sd>    >>> try_int_mul(a, 1107055232.6334295)</span>
<span class=sd>    14296455927845986412272147350433876910362542595277171600320805129204174\</span>
<span class=sd>701824227341993224688128568101787206140720134279287421051283535763162532066\</span>
<span class=sd>1082072819079131257940844247255813910836282210665242651249270543058782206016\</span>
<span class=sd>0195030665164058974557661094866963676618764040698636345181586979396240926480\</span>
<span class=sd>38619836809751492028454165243512720617990761805723389</span>

<span class=sd>    >>> try_int_mul(1202489289292969, 2.1583639585424923e+306)</span>
<span class=sd>    2595409542543320772685210126638700000000000000000000000000000000000000000\</span>
<span class=sd>00000000000000000000000000000000000000000000000000000000000000000000000000000\</span>
<span class=sd>00000000000000000000000000000000000000000000000000000000000000000000000000000\</span>
<span class=sd>00000000000000000000000000000000000000000000000000000000000000000000000000000\</span>
<span class=sd>000000000000000000</span>

<span class=sd>    # exact result: -7952338024951495584.4756757</span>
<span class=sd>    >>> try_int_mul(-131722798246, 60371766.54947795)</span>
<span class=sd>    -7952338024951495584</span>
<span class=sd>    >>> -131722798246 * 60371766.54947795</span>
<span class=sd>    -7.952338024951496e+18</span>

<span class=sd>    # exact result: 374987726685442496656857448.375</span>
<span class=sd>    >>> try_int_mul(-197846874313873, -1895343194002.375)</span>
<span class=sd>    374987726685442496656857448</span>
<span class=sd>    >>> -197846874313873 * -1895343194002.375</span>
<span class=sd>    3.749877266854425e+26</span>

<span class=sd>    # exact result: 10775411722410520324.9</span>
<span class=sd>    >>> try_int_mul(187295, 57531763914736.22)</span>
<span class=sd>    10775411722410520091</span>
<span class=sd>    >>> 187295 * 57531763914736.22</span>
<span class=sd>    1.077541172241052e+19</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_int_mul(5.0, 1)</span>
<span class=sd>    ... except TypeError as te:</span>
<span class=sd>    ...     print(te)</span>
<span class=sd>    a should be an instance of int but is float, namely 5.0.</span>

<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_int_mul(5, "x")</span>
<span class=sd>    ... except TypeError as te:</span>
<span class=sd>    ...     print(te)</span>
<span class=sd>    b should be an instance of any in {float, int} but is str, namely 'x'.</span>

<span class=sd>    >>> from math import inf</span>
<span class=sd>    >>> try:</span>
<span class=sd>    ...     try_int_mul(5, inf)</span>
<span class=sd>    ... except ValueError as ve:</span>
<span class=sd>    ...     print(ve)</span>
<span class=sd>    b=inf is not finite</span>
<span class=sd>    """</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=s2>"a"</span><span class=p>,</span> <span class=nb>int</span><span class=p>)</span>
    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>a</span> <span class=o>*</span> <span class=n>b</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=nb>float</span><span class=p>):</span>
        <span class=k>raise</span> <span class=n>type_error</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=s2>"b"</span><span class=p>,</span> <span class=p>(</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>))</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=n>isfinite</span><span class=p>(</span><span class=n>b</span><span class=p>):</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>b</span><span class=si>=}</span><span class=s2> is not finite"</span><span class=p>)</span>

    <span class=c1># First we attempt to turn b into an integer, because that would solve all</span>
    <span class=c1># of our problems.</span>
    <span class=n>b</span> <span class=o>=</span> <span class=n>__try_int</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>
    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>a</span> <span class=o>*</span> <span class=n>b</span>  <span class=c1># We are lucky, the result is an integer</span>

    <span class=n>minus</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span>
    <span class=k>if</span> <span class=n>a</span> <span class=o><</span> <span class=mi>0</span><span class=p>:</span>
        <span class=n>a</span> <span class=o>=</span> <span class=o>-</span><span class=n>a</span>
        <span class=n>minus</span> <span class=o>=</span> <span class=kc>True</span>
    <span class=k>if</span> <span class=n>b</span> <span class=o><</span> <span class=mi>0</span><span class=p>:</span>
        <span class=n>b</span> <span class=o>=</span> <span class=o>-</span><span class=n>b</span>
        <span class=n>minus</span> <span class=o>=</span> <span class=ow>not</span> <span class=n>minus</span>

    <span class=c1># Try to get the result as floating point number</span>
    <span class=n>float_res</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=nb>float</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=k>with</span> <span class=n>suppress</span><span class=p>(</span><span class=ne>ArithmeticError</span><span class=p>):</span>
        <span class=n>float_res</span> <span class=o>=</span> <span class=n>a</span> <span class=o>*</span> <span class=n>b</span>
        <span class=n>float_res</span> <span class=o>=</span> <span class=n>__try_int</span><span class=p>(</span><span class=n>float_res</span><span class=p>)</span> <span class=k>if</span> <span class=n>isfinite</span><span class=p>(</span><span class=n>float_res</span><span class=p>)</span> <span class=k>else</span> <span class=kc>None</span>

    <span class=c1># pylint: disable=R0916</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>float_res</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>)</span> <span class=ow>and</span> <span class=p>(</span><span class=nb>isinstance</span><span class=p>(</span><span class=n>float_res</span><span class=p>,</span> <span class=nb>int</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span>
            <span class=n>a</span> <span class=o>>=</span> <span class=n>__DBL_INT_LIMIT_P_I</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=n>b</span> <span class=o>>=</span> <span class=n>__DBL_INT_LIMIT_P_I</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span>
            <span class=p>(</span><span class=n>a</span> <span class=o><=</span> <span class=n>__DBL_INT_LIMIT_P_I</span><span class=p>)</span> <span class=ow>and</span> <span class=p>(</span><span class=n>b</span> <span class=o><=</span> <span class=n>__DBL_INT_LIMIT_P_I</span><span class=p>)</span> <span class=ow>and</span> <span class=p>(</span>
            <span class=n>float_res</span> <span class=o><=</span> <span class=n>__DBL_INT_LIMIT_P_F</span><span class=p>))):</span>
        <span class=c1># If float_res could be transformed to an int, then we are good.</span>
        <span class=c1># If either a or b are outside of the range where we can represent</span>
        <span class=c1># digits exactly, then there is nothing that we can do and we may</span>
        <span class=c1># as well return the result of the floating point computation.</span>
        <span class=c1># Trying to use integers would suggest a precision that we cannot</span>
        <span class=c1># offer.</span>
        <span class=c1># Alternatively, if everything falls into the range where we do not</span>
        <span class=c1># have a loss of precision, then trying anything would be odd.</span>
        <span class=c1># Using integer precision would be pretentious.</span>
        <span class=k>return</span> <span class=o>-</span><span class=n>float_res</span> <span class=k>if</span> <span class=n>minus</span> <span class=k>else</span> <span class=n>float_res</span>  <span class=c1># pylint: disable=E1130</span>

    <span class=n>num</span><span class=p>,</span> <span class=n>denom</span> <span class=o>=</span> <span class=n>float_to_frac</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>try_int_div</span><span class=p>(</span><span class=n>a</span> <span class=o>*</span> <span class=n>num</span><span class=p>,</span> <span class=n>denom</span><span class=p>)</span>
    <span class=k>return</span> <span class=o>-</span><span class=n>result</span> <span class=k>if</span> <span class=n>minus</span> <span class=k>else</span> <span class=n>result</span></div>



<div class=viewcode-block id=ceil_div>
<a class=viewcode-back href=../../../pycommons.math.html#pycommons.math.int_math.ceil_div>[docs]</a>
<span class=k>def</span><span class=w> </span><span class=nf>ceil_div</span><span class=p>(</span><span class=n>a</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>b</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-></span> <span class=nb>int</span><span class=p>:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Compute a ceiling division of two integers.</span>

<span class=sd>    :param a: the number to be divided by `b`</span>
<span class=sd>    :param b: the number dividing `a`</span>
<span class=sd>    :returns: the rounded-up result of the division</span>

<span class=sd>    >>> ceil_div(1, 1)</span>
<span class=sd>    1</span>
<span class=sd>    >>> ceil_div(-1, 1)</span>
<span class=sd>    -1</span>
<span class=sd>    >>> ceil_div(-1, -1)</span>
<span class=sd>    1</span>
<span class=sd>    >>> ceil_div(1, -1)</span>
<span class=sd>    -1</span>
<span class=sd>    >>> ceil_div(98, 98)</span>
<span class=sd>    1</span>
<span class=sd>    >>> ceil_div(98, 99)</span>
<span class=sd>    1</span>
<span class=sd>    >>> ceil_div(98, 97)</span>
<span class=sd>    2</span>
<span class=sd>    >>> ceil_div(98, -97)</span>
<span class=sd>    -1</span>
<span class=sd>    >>> ceil_div(-98, -97)</span>
<span class=sd>    2</span>
<span class=sd>    >>> ceil_div(-98, 97)</span>
<span class=sd>    -1</span>
<span class=sd>    >>> ceil_div(3, 1)</span>
<span class=sd>    3</span>
<span class=sd>    >>> ceil_div(3, -1)</span>
<span class=sd>    -3</span>
<span class=sd>    >>> ceil_div(-3, 1)</span>
<span class=sd>    -3</span>
<span class=sd>    >>> ceil_div(-3, -1)</span>
<span class=sd>    3</span>
<span class=sd>    >>> ceil_div(3, 2)</span>
<span class=sd>    2</span>
<span class=sd>    >>> ceil_div(3, -2)</span>
<span class=sd>    -1</span>
<span class=sd>    >>> ceil_div(-3, 2)</span>
<span class=sd>    -1</span>
<span class=sd>    >>> ceil_div(-3, -2)</span>
<span class=sd>    2</span>
<span class=sd>    >>> ceil_div(3, 3)</span>
<span class=sd>    1</span>
<span class=sd>    >>> ceil_div(3, 4)</span>
<span class=sd>    1</span>
<span class=sd>    >>> ceil_div(3, -4)</span>
<span class=sd>    0</span>
<span class=sd>    >>> ceil_div(-3, 4)</span>
<span class=sd>    0</span>
<span class=sd>    >>> ceil_div(-3, -4)</span>
<span class=sd>    1</span>
<span class=sd>    >>> ceil_div(4, 1)</span>
<span class=sd>    4</span>
<span class=sd>    >>> ceil_div(4, 2)</span>
<span class=sd>    2</span>
<span class=sd>    >>> ceil_div(4, 3)</span>
<span class=sd>    2</span>
<span class=sd>    >>> ceil_div(4, 4)</span>
<span class=sd>    1</span>
<span class=sd>    >>> ceil_div(4, 5)</span>
<span class=sd>    1</span>
<span class=sd>    >>> ceil_div(4, 23242398)</span>
<span class=sd>    1</span>
<span class=sd>    >>> ceil_div(4, -23242398)</span>
<span class=sd>    0</span>
<span class=sd>    >>> ceil_div(-4, 23242398)</span>
<span class=sd>    0</span>
<span class=sd>    >>> ceil_div(-4, -23242398)</span>
<span class=sd>    1</span>
<span class=sd>    >>> ceil_div(0, 1)</span>
<span class=sd>    0</span>
<span class=sd>    >>> ceil_div(0, -1)</span>
<span class=sd>    0</span>
<span class=sd>    >>> ceil_div(-0, 1)</span>
<span class=sd>    0</span>
<span class=sd>    >>> ceil_div(-0, -1)</span>
<span class=sd>    0</span>
<span class=sd>    >>> try:</span>
<span class=sd>    ...     ceil_div(1, 0)</span>
<span class=sd>    ... except ZeroDivisionError as ze:</span>
<span class=sd>    ...     print(ze)</span>
<span class=sd>    integer division or modulo by zero</span>
<span class=sd>    >>> try:</span>
<span class=sd>    ...     ceil_div(-1, 0)</span>
<span class=sd>    ... except ZeroDivisionError as ze:</span>
<span class=sd>    ...     print(ze)</span>
<span class=sd>    integer division or modulo by zero</span>
<span class=sd>    >>> try:</span>
<span class=sd>    ...     ceil_div(1, -0)</span>
<span class=sd>    ... except ZeroDivisionError as ze:</span>
<span class=sd>    ...     print(ze)</span>
<span class=sd>    integer division or modulo by zero</span>
<span class=sd>    >>> try:</span>
<span class=sd>    ...     ceil_div(-1, -0)</span>
<span class=sd>    ... except ZeroDivisionError as ze:</span>
<span class=sd>    ...     print(ze)</span>
<span class=sd>    integer division or modulo by zero</span>
<span class=sd>    """</span>
    <span class=k>return</span> <span class=o>-</span><span class=p>((</span><span class=o>-</span><span class=n>a</span><span class=p>)</span> <span class=o>//</span> <span class=n>b</span><span class=p>)</span></div>

</pre></div><div class=clearer></div></div></div></div><div aria-label=Main class=sphinxsidebar role=navigation><div class=sphinxsidebarwrapper><search id=searchbox role=search style=display:none> <h3 id=searchlabel>Quick search</h3> <div class=searchformwrapper><form action=../../../search.html class=search><input aria-labelledby=searchlabel autocapitalize=off autocomplete=off autocorrect=off name=q spellcheck=false><input type=submit value=Go></form></div> </search><script>document.getElementById(`searchbox`).style.display=`block`</script></div></div><div class=clearer></div></div><div aria-label=Related class=related role=navigation><h3>Navigation</h3><ul><li class=right style=margin-right:10px><a title="General Index"href=../../../genindex.html>index</a><li class=right><a title="Python Module Index"href=../../../py-modindex.html>modules</a> |<li class="nav-item nav-item-0"><a href=../../../index.html>pycommons 0.8.70 documentation</a> »<li class="nav-item nav-item-1"><a href=../../index.html>Module code</a> »<li class="nav-item nav-item-this"><a href>pycommons.math.int_math</a></ul></div><div class=footer role=contentinfo>© Copyright 2023-2025, Thomas Weise.</div>
